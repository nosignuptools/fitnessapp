const renderView=(e,t=null)=>{DataService.setAppState("lastView",e).catch(e=>{console.warn("Failed to save navigation state:",e)});const a=document.getElementById("app");let n;switch(a.innerHTML="",e){case"home":n=HomeView.render();break;case"logFood":n=LogFoodView.render();break;case"logDetail":n=LogDetailView.render(t);break;case"addCustomFood":n=AddCustomFoodView.render();break;case"setPrices":n=SetPricesView.render();break;case"storeManager":n=StoreManagerView.render();break;case"selectFoodForPrice":n=SelectFoodForPriceView.render();break;case"foodHistory":n=FoodHistoryView.render(t);break;case"selectDateRange":n=DateRangeView.render(t);break;case"setGoals":n=GoalsView.render();break;case"workout":n=WorkoutView.render();break;case"metrics":n=MetricsView.render();break;case"editWorkoutDetail":n=EditWorkoutDetailView.render(t);break;case"selectExercise":n=SelectExerciseView.render(t);break;case"createNewExercise":n=CreateNewExerciseView.render(t);break;case"workoutSession":n=WorkoutSessionView.render(t);break;case"workoutHistory":n=WorkoutHistoryView.render(t);break;default:n="<h1>404: Page Not Found</h1>"}a.innerHTML=n,document.querySelectorAll(".bottom-nav .nav-item").forEach(t=>{t.getAttribute("data-view")===e?t.classList.add("active"):t.classList.remove("active")}),"home"===e?HomeView.initEvents():"logFood"===e?LogFoodView.initEvents():"logDetail"===e?LogDetailView.initEvents(t):"addCustomFood"===e?AddCustomFoodView.initEvents():"setPrices"===e?SetPricesView.initEvents():"storeManager"===e?StoreManagerView.initEvents():"selectFoodForPrice"===e?SelectFoodForPriceView.initEvents():"foodHistory"===e?FoodHistoryView.initEvents(t):"selectDateRange"===e?DateRangeView.initEvents(t):"setGoals"===e?GoalsView.initEvents():"workout"===e?WorkoutView.initEvents():"metrics"===e?MetricsView.initEvents():"editWorkoutDetail"===e?EditWorkoutDetailView.initEvents(t):"selectExercise"===e?SelectExerciseView.initEvents(t):"createNewExercise"===e?CreateNewExerciseView.initEvents(t):"workoutSession"===e?WorkoutSessionView.initEvents(t):"workoutHistory"===e&&WorkoutHistoryView.initEvents(t)},renderModalTemplate=()=>'\n        <div id="universal-modal" class="modal-overlay">\n            <div class="modal-content">\n                <h3 id="modal-title" style="margin-top: 0;"></h3>\n                <p id="modal-message" style="color: var(--color-text-secondary);"></p>\n                <div id="modal-actions" class="modal-actions">\n                    </div>\n            </div>\n        </div>\n    ';window.showModal=(e,t,a="alert")=>new Promise(n=>{const o=document.getElementById("universal-modal"),r=document.getElementById("modal-title"),i=document.getElementById("modal-message"),s=document.getElementById("modal-actions");r.textContent=e,i.innerHTML=t,s.innerHTML="";const l=e=>{o.style.display="none",n(e)};if(window.closeModal=l,"alert"===a){const e=document.createElement("button");e.className="btn",e.textContent="OK",e.style.backgroundColor="var(--color-primary-green)",e.addEventListener("click",()=>l(!0)),s.appendChild(e)}else if("confirm"===a){const e=document.createElement("button");e.className="btn btn-cancel",e.textContent="CANCEL",e.addEventListener("click",()=>l(!1));const t=document.createElement("button");t.className="btn btn-delete-confirm",t.textContent="CONFIRM",t.addEventListener("click",()=>l(!0)),s.appendChild(e),s.appendChild(t)}o.style.display="flex"});const attachNavListeners=()=>{document.querySelectorAll(".bottom-nav .nav-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const a=e.getAttribute("data-view");window.renderView(a)})})};document.addEventListener("DOMContentLoaded",()=>{window.renderView=renderView;const e=document.getElementById("app");document.body.insertAdjacentHTML("beforeend",renderModalTemplate()),e.innerHTML="<h1>Loading Fitness App Data...</h1><p>Initializing local database connection...</p>",window.DB&&"function"==typeof window.DB.initDB?DB.initDB().then(async()=>{console.log("IndexedDB initialized successfully. Starting application.");const e=await DataService.getAppState("lastView"),t=e&&["home","workout","metrics"].includes(e)?e:"home";attachNavListeners(),renderView(t)}).catch(t=>{console.error("Failed to initialize database. App cannot start.",t),e.innerHTML="<h1>Data Error</h1><p>Failed to load local database. Please check console for details.</p>"}):e.innerHTML="<h1>Error</h1><p>Missing required IndexedDB library (db.js). Please check file inclusion in index.html.</p>"});const STORE_GOALS="goals",STORE_LOGS="logEntries",STORE_STORES="priceStores",STORE_PRICES="priceRecords",STORE_CUSTOM_FOODS="customFoods",STORE_SETTINGS="settings",STORE_WORKOUTS="savedWorkouts",STORE_CUSTOM_EXERCISES="customExercises",STORE_WORKOUT_HISTORY="workoutHistory",STORE_WEIGHT_HISTORY="weightHistory",IMPORT_EXPORT_KEYS=["goals",STORE_LOGS,STORE_STORES,STORE_PRICES,"customFoods",STORE_WORKOUTS,"customExercises","workoutHistory","weightHistory"],DataService=(()=>{const e=e=>new Date(e).toLocaleDateString("en-US"),t={calories:1e3,protein:1212,carbs:1221,fats:2121},a="appGoals",n=()=>new Promise(e=>{DB.transact("goals","readonly").then(n=>{const r=n.get(a);r.onsuccess=()=>{const a=r.result;a?e(a):o(t).then(()=>e(t))},r.onerror=()=>e(t)}).catch(()=>e(t))}),o=e=>new Promise((t,n)=>{DB.transact("goals","readwrite").then(o=>{const r=o.put(e,a);r.onsuccess=()=>t(e),r.onerror=e=>n(e.target.error)}).catch(n)}),r=()=>new Promise((e,t)=>{DB.transact(STORE_LOGS,"readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)}),i=()=>new Promise((e,t)=>{DB.transact(STORE_STORES,"readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)}),s=()=>new Promise((e,t)=>{DB.transact(STORE_PRICES,"readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)});return{getGoals:n,setGoals:o,saveLogEntry:t=>new Promise((a,n)=>{DB.transact(STORE_LOGS,"readwrite").then(o=>{t.date=e(new Date);const r=o.add(t);r.onsuccess=()=>a(r.result),r.onerror=e=>n(e.target.error)}).catch(n)}),updateLogEntry:e=>new Promise((t,a)=>{DB.transact(STORE_LOGS,"readwrite").then(n=>{const o=n.get(e.id);o.onsuccess=()=>{const r=o.result;if(!r)return a("Entry not found for update.");e.date=r.date;const i=n.put(e);i.onsuccess=()=>t(!0),i.onerror=e=>a(e.target.error)},o.onerror=e=>a(e.target.error)}).catch(a)}),deleteLogEntry:e=>new Promise((t,a)=>{DB.transact(STORE_LOGS,"readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),getTodayLogEntries:async()=>{const t=e(new Date);return(await r()).filter(e=>e.date===t).sort((e,t)=>t.id-e.id)},getLogEntryById:e=>new Promise((t,a)=>{DB.transact(STORE_LOGS,"readonly").then(n=>{const o=n.get(e);o.onsuccess=()=>t(o.result),o.onerror=e=>a(e.target.error)}).catch(a)}),getStores:i,saveStore:e=>new Promise((t,a)=>{DB.transact(STORE_STORES,"readwrite").then(n=>{const o={name:e},r=n.add(o);r.onsuccess=()=>t({id:r.result,name:e}),r.onerror=e=>a(e.target.error)}).catch(a)}),deleteStore:e=>new Promise((t,a)=>{DB.transact(STORE_STORES,"readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),getPriceRecords:s,savePriceRecord:e=>new Promise((t,a)=>{DB.transact(STORE_PRICES,"readwrite").then(n=>{const o=n.add(e);o.onsuccess=()=>t(o.result),o.onerror=e=>a(e.target.error)}).catch(a)}),deletePriceRecord:e=>new Promise((t,a)=>{DB.transact(STORE_PRICES,"readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),getPricesByFoodId:async e=>{const[t,a]=await Promise.all([s(),i()]);return t.filter(t=>t.foodId===e).map(e=>{const t=a.find(t=>t.id===e.storeId),n=e.price/e.amount;return{id:e.id,storeName:t?t.name:"Unknown Store",priceText:`$${e.price.toFixed(2)} / ${e.amount}${e.unit}`,unitCost:n}})},clearStore:e=>new Promise((t,a)=>{DB.transact(e,"readwrite").then(e=>{const n=e.clear();n.onsuccess=()=>t(!0),n.onerror=e=>a(e.target.error)}).catch(a)}),exportAllData:async()=>{const e={};for(const t of IMPORT_EXPORT_KEYS)try{if("goals"===t)e[t]=await n();else{const a=await new Promise((e,a)=>{DB.transact(t,"readonly").then(t=>{const n=t.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>a(e.target.error)}).catch(a)});e[t]=a}}catch(e){console.warn(`Could not export store ${t}:`,e)}return e},importData:async e=>{let t=0;const n=[];for(const o of IMPORT_EXPORT_KEYS)e.hasOwnProperty(o)&&(t++,n.push(new Promise((t,n)=>{DB.transact(o,"readwrite").then(r=>{const i=e[o],s=r.clear();s.onsuccess=()=>{"goals"===o?r.put(i,a).onsuccess=t:(Array.isArray(i)&&i.forEach(e=>r.put(e)),t())},s.onerror=n}).catch(n)})));return await Promise.all(n),t},DATA_KEYS:IMPORT_EXPORT_KEYS,getLogEntriesByRange:async(e,t)=>{const a=await r(),n=new Date(e).getTime(),o=new Date(t).getTime(),i=a.filter(e=>{const t=new Date(e.date).getTime();return t>=n&&t<=o}).sort((e,t)=>t.id-e.id);return{entries:i,totals:i.reduce((e,t)=>(e.protein+=t.totalProtein,e.carbs+=t.totalCarbs,e.fat+=t.totalFats,e.cost+=t.price,e),{protein:0,carbs:0,fat:0,cost:0})}},getRangeDates:e=>{const t=new Date,a=new Date(t);let n=new Date(t);return a.setHours(0,0,0,0),n.setHours(23,59,59,999),"WEEK"===e?a.setDate(t.getDate()-t.getDay()):"MONTH"===e?a.setDate(1):"YEAR"===e&&a.setMonth(0,1),{start:a.getTime(),end:n.getTime()}},resetFoodHistory:()=>new Promise((e,t)=>{DB.transact(STORE_LOGS,"readwrite").then(a=>{const n=a.clear();n.onsuccess=()=>e(!0),n.onerror=e=>t(e.target.error)}).catch(t)}),getAppState:e=>new Promise((t,a)=>{DB.transact("settings","readonly").then(a=>{const n=a.get(e);n.onsuccess=()=>t(n.result),n.onerror=()=>t(null)}).catch(()=>t(null))}),setAppState:(e,t)=>new Promise((a,n)=>{DB.transact("settings","readwrite").then(o=>{const r=o.put(t,e);r.onsuccess=()=>a(!0),r.onerror=e=>n(e.target.error)}).catch(n)}),getWorkouts:()=>new Promise((e,t)=>{DB.transact(STORE_WORKOUTS,"readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)}),saveWorkout:e=>new Promise((t,a)=>{DB.transact(STORE_WORKOUTS,"readwrite").then(n=>{const o={name:e,exercises:[]},r=n.add(o);r.onsuccess=()=>t({id:r.result,...o}),r.onerror=e=>a(e.target.error)}).catch(a)}),deleteWorkout:e=>new Promise((t,a)=>{DB.transact(STORE_WORKOUTS,"readwrite").then(n=>{const o=n.delete(parseInt(e,10));o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),updateWorkoutName:(e,t)=>new Promise((a,n)=>{DB.transact(STORE_WORKOUTS,"readwrite").then(o=>{const r=o.get(parseInt(e,10));r.onsuccess=()=>{const e=r.result;if(!e)return n("Workout not found.");e.name=t;const i=o.put(e);i.onsuccess=()=>a(!0),i.onerror=e=>n(e.target.error)},r.onerror=e=>n(e.target.error)}).catch(n)}),getWorkoutById:e=>new Promise((t,a)=>{DB.transact(STORE_WORKOUTS,"readonly").then(n=>{const o=n.get(parseInt(e,10));o.onsuccess=()=>{t(o.result)},o.onerror=e=>a(e.target.error)}).catch(a)}),updateWorkout:e=>new Promise((t,a)=>{DB.transact(STORE_WORKOUTS,"readwrite").then(n=>{const o=n.put(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),getCustomExercises:()=>new Promise((e,t)=>{DB.transact("customExercises","readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)}),deleteCustomExercise:e=>new Promise((t,a)=>{DB.transact("customExercises","readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),saveCustomExercise:e=>new Promise((t,a)=>{e.id="e"+Date.now(),DB.transact("customExercises","readwrite").then(n=>{const o=n.add(e);o.onsuccess=()=>t(e),o.onerror=e=>a(e.target.error)}).catch(a)}),addExerciseToWorkout:(e,t)=>new Promise((a,n)=>{DB.transact(STORE_WORKOUTS,"readwrite").then(o=>{const r=o.get(parseInt(e,10));r.onsuccess=()=>{const e=r.result;if(!e)return n("Workout not found.");e.exercises||(e.exercises=[]);const i={...t,sets:t.sets||null,reps:t.reps||null};e.exercises.some(e=>e.id===t.id)||e.exercises.push(i);const s=o.put(e);s.onsuccess=()=>a(e),s.onerror=e=>n(e.target.error)},r.onerror=e=>n(e.target.error)}).catch(n)}),saveWorkoutSession:e=>new Promise((t,a)=>{DB.transact("workoutHistory","readwrite").then(n=>{const o=n.add(e);o.onsuccess=()=>t(o.result),o.onerror=e=>a(e.target.error)}).catch(a)}),getWorkoutHistory:()=>new Promise((e,t)=>{DB.transact("workoutHistory","readonly").then(a=>{const n=a.getAll();n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)}).catch(t)}),deleteWorkoutHistoryEntry:e=>new Promise((t,a)=>{DB.transact("workoutHistory","readwrite").then(n=>{const o=n.delete(parseInt(e,10));o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)}),updateWorkoutHistoryName:(e,t)=>new Promise((a,n)=>{DB.transact("workoutHistory","readwrite").then(o=>{const r=o.get(parseInt(e,10));r.onsuccess=()=>{const e=r.result;if(!e)return n("History entry not found.");e.workoutName=t;const i=o.put(e);i.onsuccess=()=>a(!0),i.onerror=e=>n(e.target.error)},r.onerror=e=>n(e.target.error)}).catch(n)}),logWeightEntry:e=>new Promise((t,a)=>{DB.transact("weightHistory","readwrite").then(n=>{const o={weight:e,timestamp:Date.now()},r=n.add(o);r.onsuccess=()=>t(r.result),r.onerror=e=>a(e.target.error)}).catch(a)}),getLatestWeight:()=>new Promise((e,t)=>{DB.transact("weightHistory","readonly").then(a=>{const n=a.index("timestamp").openCursor(null,"prev");n.onsuccess=t=>{const a=t.target.result;e(a?a.value:null)},n.onerror=e=>t(e.target.error)}).catch(t)}),getWeightHistoryByRange:(e,t)=>new Promise((a,n)=>{DB.transact("weightHistory","readonly").then(o=>{const r=o.index("timestamp"),i=IDBKeyRange.bound(e,t),s=r.getAll(i);s.onsuccess=()=>{const e=s.result.sort((e,t)=>t.timestamp-e.timestamp);a(e)},s.onerror=e=>n(e.target.error)}).catch(n)}),deleteWeightEntry:e=>new Promise((t,a)=>{DB.transact("weightHistory","readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)})}})(),DB_NAME="FitnessAppDB",DB_VERSION=6;let db;const transact=(e,t)=>new Promise((a,n)=>{if(!db)return void n("Database not initialized. Call initDB first.");const o=db.transaction(e,t),r=o.objectStore(e);o.oncomplete=()=>{},o.onerror=e=>n(e.target.error),o.onabort=e=>n("Transaction aborted."),a(r)}),initDB=()=>new Promise((e,t)=>{if(db)return void e(db);const a=indexedDB.open(DB_NAME,6);a.onerror=e=>{console.error("Database error:",e.target.error),t(e.target.error)},a.onupgradeneeded=e=>{const t=e.target.result;if(t.objectStoreNames.contains("goals")||t.createObjectStore("goals"),!t.objectStoreNames.contains("logEntries")){t.createObjectStore("logEntries",{keyPath:"id",autoIncrement:!0}).createIndex("date","date",{unique:!1})}if(t.objectStoreNames.contains("priceStores")||t.createObjectStore("priceStores",{keyPath:"id",autoIncrement:!0}),!t.objectStoreNames.contains("priceRecords")){t.createObjectStore("priceRecords",{keyPath:"id",autoIncrement:!0}).createIndex("foodId","foodId",{unique:!1})}if(t.objectStoreNames.contains("customFoods")||t.createObjectStore("customFoods",{keyPath:"id"}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings"),t.objectStoreNames.contains("savedWorkouts")||t.createObjectStore("savedWorkouts",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("customExercises")||t.createObjectStore("customExercises",{keyPath:"id"}),!t.objectStoreNames.contains("workoutHistory")){t.createObjectStore("workoutHistory",{keyPath:"id",autoIncrement:!0}).createIndex("date","date",{unique:!1})}if(!t.objectStoreNames.contains("weightHistory")){t.createObjectStore("weightHistory",{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})}},a.onsuccess=t=>{db=t.target.result,e(db)}});window.DB={initDB:initDB,transact:transact};const STATIC_EXERCISES=[{id:"e001",name:"Bench Press (Barbell)",muscle:"chest",equipment:"barbell",type:"static"},{id:"e002",name:"Incline Dumbbell Press",muscle:"chest",equipment:"dumbbell",type:"static"},{id:"e003",name:"Pec Deck Fly",muscle:"chest",equipment:"machine",type:"static"},{id:"e004",name:"Push Up",muscle:"chest",equipment:"bodyweight",type:"static"},{id:"e005",name:"Cable Crossover",muscle:"chest",equipment:"cable",type:"static"},{id:"e006",name:"Dumbbell Fly",muscle:"chest",equipment:"dumbbell",type:"static"},{id:"e007",name:"Decline Bench Press (Barbell)",muscle:"chest",equipment:"barbell",type:"static"},{id:"e008",name:"Incline Bench Press (Barbell)",muscle:"chest",equipment:"barbell",type:"static"},{id:"e009",name:"Decline Dumbbell Press",muscle:"chest",equipment:"dumbbell",type:"static"},{id:"e010",name:"Chest Press Machine",muscle:"chest",equipment:"machine",type:"static"},{id:"e011",name:"Incline Cable Fly",muscle:"chest",equipment:"cable",type:"static"},{id:"e012",name:"Decline Cable Fly",muscle:"chest",equipment:"cable",type:"static"},{id:"e013",name:"Diamond Push Up",muscle:"chest",equipment:"bodyweight",type:"static"},{id:"e014",name:"Dips (Chest Focused)",muscle:"chest",equipment:"bodyweight",type:"static"},{id:"e015",name:"Landmine Press",muscle:"chest",equipment:"barbell",type:"static"},{id:"e016",name:"Pull Up",muscle:"lats",equipment:"bodyweight",type:"static"},{id:"e017",name:"Lat Pulldown",muscle:"lats",equipment:"machine",type:"static"},{id:"e018",name:"Dumbbell Row (Single Arm)",muscle:"back",equipment:"dumbbell",type:"static"},{id:"e019",name:"Deadlift (Barbell)",muscle:"back",equipment:"barbell",type:"static"},{id:"e020",name:"Barbell Row",muscle:"back",equipment:"barbell",type:"static"},{id:"e021",name:"Seated Cable Row",muscle:"back",equipment:"cable",type:"static"},{id:"e022",name:"Face Pull",muscle:"traps",equipment:"cable",type:"static"},{id:"e023",name:"Hyperextension",muscle:"back",equipment:"bodyweight",type:"static"},{id:"e024",name:"T-Bar Row (Machine)",muscle:"back",equipment:"machine",type:"static"},{id:"e025",name:"Chin Up",muscle:"lats",equipment:"bodyweight",type:"static"},{id:"e026",name:"Wide Grip Lat Pulldown",muscle:"lats",equipment:"machine",type:"static"},{id:"e027",name:"Close Grip Lat Pulldown",muscle:"lats",equipment:"machine",type:"static"},{id:"e028",name:"Pendlay Row",muscle:"back",equipment:"barbell",type:"static"},{id:"e029",name:"Dumbbell Row (Both Arms)",muscle:"back",equipment:"dumbbell",type:"static"},{id:"e030",name:"Chest Supported Row (Machine)",muscle:"back",equipment:"machine",type:"static"},{id:"e031",name:"Inverted Row",muscle:"back",equipment:"bodyweight",type:"static"},{id:"e032",name:"Straight Arm Pulldown",muscle:"lats",equipment:"cable",type:"static"},{id:"e033",name:"Meadows Row",muscle:"back",equipment:"barbell",type:"static"},{id:"e034",name:"Rack Pull",muscle:"back",equipment:"barbell",type:"static"},{id:"e035",name:"Seal Row",muscle:"back",equipment:"barbell",type:"static"},{id:"e036",name:"Squat (Barbell)",muscle:"quads",equipment:"barbell",type:"static"},{id:"e037",name:"Leg Press",muscle:"quads",equipment:"machine",type:"static"},{id:"e038",name:"Lunge (Dumbbell)",muscle:"quads",equipment:"dumbbell",type:"static"},{id:"e039",name:"Leg Extension",muscle:"quads",equipment:"machine",type:"static"},{id:"e040",name:"Front Squat (Barbell)",muscle:"quads",equipment:"barbell",type:"static"},{id:"e041",name:"Bulgarian Split Squat (Dumbbell)",muscle:"quads",equipment:"dumbbell",type:"static"},{id:"e042",name:"Hack Squat (Machine)",muscle:"quads",equipment:"machine",type:"static"},{id:"e043",name:"Goblet Squat (Dumbbell)",muscle:"quads",equipment:"dumbbell",type:"static"},{id:"e044",name:"Walking Lunge (Dumbbell)",muscle:"quads",equipment:"dumbbell",type:"static"},{id:"e045",name:"Step Up (Dumbbell)",muscle:"quads",equipment:"dumbbell",type:"static"},{id:"e046",name:"Sissy Squat",muscle:"quads",equipment:"bodyweight",type:"static"},{id:"e047",name:"Box Squat (Barbell)",muscle:"quads",equipment:"barbell",type:"static"},{id:"e048",name:"Romanian Deadlift (Barbell)",muscle:"hamstrings",equipment:"barbell",type:"static"},{id:"e049",name:"Leg Curl (Lying)",muscle:"hamstrings",equipment:"machine",type:"static"},{id:"e050",name:"Glute Ham Raise (GHR)",muscle:"hamstrings",equipment:"machine",type:"static"},{id:"e051",name:"Romanian Deadlift (Dumbbell)",muscle:"hamstrings",equipment:"dumbbell",type:"static"},{id:"e052",name:"Leg Curl (Seated)",muscle:"hamstrings",equipment:"machine",type:"static"},{id:"e053",name:"Single Leg Romanian Deadlift (Dumbbell)",muscle:"hamstrings",equipment:"dumbbell",type:"static"},{id:"e054",name:"Stiff Leg Deadlift (Barbell)",muscle:"hamstrings",equipment:"barbell",type:"static"},{id:"e055",name:"Nordic Curl",muscle:"hamstrings",equipment:"bodyweight",type:"static"},{id:"e056",name:"Cable Pull Through",muscle:"hamstrings",equipment:"cable",type:"static"},{id:"e057",name:"Good Morning (Barbell)",muscle:"hamstrings",equipment:"barbell",type:"static"},{id:"e058",name:"Hip Thrust (Barbell)",muscle:"glutes",equipment:"barbell",type:"static"},{id:"e059",name:"Cable Glute Kickback",muscle:"glutes",equipment:"cable",type:"static"},{id:"e060",name:"Glute Bridge (Bodyweight)",muscle:"glutes",equipment:"bodyweight",type:"static"},{id:"e061",name:"Hip Thrust (Dumbbell)",muscle:"glutes",equipment:"dumbbell",type:"static"},{id:"e062",name:"Glute Bridge (Barbell)",muscle:"glutes",equipment:"barbell",type:"static"},{id:"e063",name:"Cable Hip Abduction",muscle:"glutes",equipment:"cable",type:"static"},{id:"e064",name:"Hip Abduction Machine",muscle:"glutes",equipment:"machine",type:"static"},{id:"e065",name:"Reverse Hyperextension",muscle:"glutes",equipment:"machine",type:"static"},{id:"e066",name:"Donkey Kick",muscle:"glutes",equipment:"bodyweight",type:"static"},{id:"e067",name:"Sumo Deadlift (Barbell)",muscle:"glutes",equipment:"barbell",type:"static"},{id:"e068",name:"Single Leg Hip Thrust",muscle:"glutes",equipment:"bodyweight",type:"static"},{id:"e069",name:"Overhead Press (Dumbbell)",muscle:"shoulders",equipment:"dumbbell",type:"static"},{id:"e070",name:"Lateral Raise (Cable)",muscle:"shoulders",equipment:"cable",type:"static"},{id:"e071",name:"Overhead Press (Barbell)",muscle:"shoulders",equipment:"barbell",type:"static"},{id:"e072",name:"Lateral Raise (Dumbbell)",muscle:"shoulders",equipment:"dumbbell",type:"static"},{id:"e073",name:"Rear Delt Fly (Machine)",muscle:"shoulders",equipment:"machine",type:"static"},{id:"e074",name:"Shrug (Barbell)",muscle:"traps",equipment:"barbell",type:"static"},{id:"e075",name:"Arnold Press (Dumbbell)",muscle:"shoulders",equipment:"dumbbell",type:"static"},{id:"e076",name:"Front Raise (Dumbbell)",muscle:"shoulders",equipment:"dumbbell",type:"static"},{id:"e077",name:"Front Raise (Cable)",muscle:"shoulders",equipment:"cable",type:"static"},{id:"e078",name:"Front Raise (Barbell)",muscle:"shoulders",equipment:"barbell",type:"static"},{id:"e079",name:"Reverse Fly (Dumbbell)",muscle:"shoulders",equipment:"dumbbell",type:"static"},{id:"e080",name:"Reverse Fly (Cable)",muscle:"shoulders",equipment:"cable",type:"static"},{id:"e081",name:"Upright Row (Barbell)",muscle:"shoulders",equipment:"barbell",type:"static"},{id:"e082",name:"Upright Row (Cable)",muscle:"shoulders",equipment:"cable",type:"static"},{id:"e083",name:"Shoulder Press Machine",muscle:"shoulders",equipment:"machine",type:"static"},{id:"e084",name:"Shrug (Dumbbell)",muscle:"traps",equipment:"dumbbell",type:"static"},{id:"e085",name:"Pike Push Up",muscle:"shoulders",equipment:"bodyweight",type:"static"},{id:"e086",name:"Bicep Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e087",name:"Barbell Curl",muscle:"biceps",equipment:"barbell",type:"static"},{id:"e088",name:"Hammer Curl (Cable Rope)",muscle:"biceps",equipment:"cable",type:"static"},{id:"e089",name:"Hammer Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e090",name:"Preacher Curl (Barbell)",muscle:"biceps",equipment:"barbell",type:"static"},{id:"e091",name:"Preacher Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e092",name:"Cable Curl",muscle:"biceps",equipment:"cable",type:"static"},{id:"e093",name:"Concentration Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e094",name:"Incline Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e095",name:"EZ Bar Curl",muscle:"biceps",equipment:"barbell",type:"static"},{id:"e096",name:"Spider Curl (Barbell)",muscle:"biceps",equipment:"barbell",type:"static"},{id:"e097",name:"Reverse Curl (Barbell)",muscle:"forearms",equipment:"barbell",type:"static"},{id:"e098",name:"Zottman Curl (Dumbbell)",muscle:"biceps",equipment:"dumbbell",type:"static"},{id:"e099",name:"Tricep Pushdown (Cable)",muscle:"triceps",equipment:"cable",type:"static"},{id:"e100",name:"Skullcrusher",muscle:"triceps",equipment:"barbell",type:"static"},{id:"e101",name:"Overhead Tricep Extension (Dumbbell)",muscle:"triceps",equipment:"dumbbell",type:"static"},{id:"e102",name:"Overhead Tricep Extension (Cable)",muscle:"triceps",equipment:"cable",type:"static"},{id:"e103",name:"Close Grip Bench Press (Barbell)",muscle:"triceps",equipment:"barbell",type:"static"},{id:"e104",name:"Dips (Tricep Focused)",muscle:"triceps",equipment:"bodyweight",type:"static"},{id:"e105",name:"Tricep Kickback (Dumbbell)",muscle:"triceps",equipment:"dumbbell",type:"static"},{id:"e106",name:"Tricep Kickback (Cable)",muscle:"triceps",equipment:"cable",type:"static"},{id:"e107",name:"Overhead Tricep Extension (Barbell)",muscle:"triceps",equipment:"barbell",type:"static"},{id:"e108",name:"Diamond Push Up",muscle:"triceps",equipment:"bodyweight",type:"static"},{id:"e109",name:"Tricep Pushdown (Rope)",muscle:"triceps",equipment:"cable",type:"static"},{id:"e110",name:"JM Press",muscle:"triceps",equipment:"barbell",type:"static"},{id:"e111",name:"Bench Dips",muscle:"triceps",equipment:"bodyweight",type:"static"},{id:"e112",name:"Standing Calf Raise",muscle:"calves",equipment:"machine",type:"static"},{id:"e113",name:"Seated Calf Raise",muscle:"calves",equipment:"machine",type:"static"},{id:"e114",name:"Calf Raise (Dumbbell)",muscle:"calves",equipment:"dumbbell",type:"static"},{id:"e115",name:"Calf Raise (Barbell)",muscle:"calves",equipment:"barbell",type:"static"},{id:"e116",name:"Single Leg Calf Raise",muscle:"calves",equipment:"bodyweight",type:"static"},{id:"e117",name:"Leg Press Calf Raise",muscle:"calves",equipment:"machine",type:"static"},{id:"e118",name:"Jump Rope",muscle:"calves",equipment:"other",type:"static"},{id:"e119",name:"Plank",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e120",name:"Crunches",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e121",name:"Cable Crunch",muscle:"abs",equipment:"cable",type:"static"},{id:"e122",name:"Hanging Leg Raise",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e123",name:"Bicycle Crunches",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e124",name:"Russian Twist",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e125",name:"Russian Twist (Dumbbell)",muscle:"abs",equipment:"dumbbell",type:"static"},{id:"e126",name:"Ab Wheel Rollout",muscle:"abs",equipment:"other",type:"static"},{id:"e127",name:"Mountain Climbers",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e128",name:"Side Plank",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e129",name:"Leg Raise (Lying)",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e130",name:"V-Up",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e131",name:"Dead Bug",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e132",name:"Pallof Press (Cable)",muscle:"core",equipment:"cable",type:"static"},{id:"e133",name:"Wood Chop (Cable)",muscle:"core",equipment:"cable",type:"static"},{id:"e134",name:"Toe Touchers",muscle:"abs",equipment:"bodyweight",type:"static"},{id:"e135",name:"Dragon Flag",muscle:"abs",equipment:"bodyweight",type:"static"}],MUSCLE_GROUPS=["All Muscles","chest","back","lats","traps","quads","hamstrings","glutes","shoulders","biceps","triceps","forearms","core","abs","calves"],EQUIPMENT_TYPES=["barbell","dumbbell","machine","bodyweight","cable","other"],ExerciseData=(()=>{let e=[];return{MUSCLE_GROUPS:MUSCLE_GROUPS,EQUIPMENT_TYPES:EQUIPMENT_TYPES,searchExercises:async(t="",a="All Muscles",n="All")=>{await(async()=>{try{e=await DataService.getCustomExercises()}catch(t){console.error("Failed to load custom exercises:",t),e=[]}})();let o=[...STATIC_EXERCISES,...e];const r=t.toLowerCase();let i=o.filter(e=>e.name.toLowerCase().includes(r));return"All Muscles"!==a&&(i=i.filter(e=>e.muscle===a.toLowerCase())),"All"!==n&&(i=i.filter(e=>e.equipment===n.toLowerCase())),i.sort((e,t)=>e.name.localeCompare(t.name))}}})(),CUSTOM_FOODS_STORE="customFoods",FoodData=(()=>{const e=[{id:"f001",name:"Chicken Breast (Cooked)",cal:165,prot:31,carb:0,fat:3.6,unit:"100g",type:"static"},{id:"f002",name:"Chicken Legs (Cooked, With Skin)",cal:172,prot:24.2,carb:0,fat:8.2,unit:"100g",type:"static"},{id:"f003",name:"Boneless Chicken Thighs",cal:197,prot:26,carb:0,fat:10,unit:"100g",type:"static"},{id:"f004",name:"Chicken Drumsticks (Cooked, With Skin)",cal:184,prot:27.3,carb:0,fat:8.4,unit:"100g",type:"static"},{id:"f005",name:"Chicken Soup (Cooked)",cal:60,prot:4.8,carb:4.8,fat:2.4,unit:"100g",type:"static"},{id:"f006",name:"Turkey Breast (Cooked)",cal:135,prot:30,carb:0,fat:.7,unit:"100g",type:"static"},{id:"f007",name:"Ground Chicken (Cooked)",cal:143,prot:17.4,carb:0,fat:8.1,unit:"100g",type:"static"},{id:"f008",name:"Eggs (Large)",cal:77.5,prot:6.3,carb:.6,fat:5.3,unit:"1 unit",type:"static"},{id:"f009",name:"Rice (Cooked, White)",cal:130,prot:2.7,carb:28.2,fat:.3,unit:"100g",type:"static"},{id:"f010",name:"Duck Breast (Cooked, No Skin)",cal:140,prot:23.5,carb:0,fat:4.5,unit:"100g",type:"static"},{id:"f011",name:"Egg Whites (Large)",cal:17,prot:3.6,carb:.2,fat:.1,unit:"1 unit",type:"static"},{id:"f012",name:"Boiled Eggs (Large)",cal:78,prot:6.3,carb:.6,fat:5.3,unit:"1 unit",type:"static"},{id:"f013",name:"Ground Beef (90% Lean)",cal:176,prot:20,carb:0,fat:10,unit:"100g",type:"static"},{id:"f014",name:"Ground Beef (85% Lean)",cal:215,prot:18.6,carb:0,fat:15,unit:"100g",type:"static"},{id:"f015",name:"Beef Steak (Ribeye, Average)",cal:291,prot:24,carb:0,fat:22,unit:"100g",type:"static"},{id:"f016",name:"Beef Sirloin Steak (Lean)",cal:183,prot:27,carb:0,fat:8,unit:"100g",type:"static"},{id:"f017",name:"Beef Tenderloin (Lean)",cal:201,prot:26,carb:0,fat:10,unit:"100g",type:"static"},{id:"f018",name:"Pork Mince (Medium)",cal:205,prot:21.2,carb:0,fat:13.3,unit:"100g",type:"static"},{id:"f019",name:"Pork Cutlet (Lean Loin Chop)",cal:231,prot:25.8,carb:0,fat:13.9,unit:"100g",type:"static"},{id:"f020",name:"Pork Neck Steak",cal:197,prot:18.3,carb:0,fat:13.8,unit:"100g",type:"static"},{id:"f021",name:"Pork Tenderloin (Lean)",cal:143,prot:26,carb:0,fat:3.5,unit:"100g",type:"static"},{id:"f022",name:"Bacon (Cooked)",cal:541,prot:37,carb:1.4,fat:42,unit:"100g",type:"static"},{id:"f023",name:"Beef Jerky",cal:410,prot:33,carb:11,fat:25,unit:"100g",type:"static"},{id:"f024",name:"Lamb Chops (Cooked)",cal:294,prot:25,carb:0,fat:21,unit:"100g",type:"static"},{id:"f025",name:"Veal Cutlet (Lean)",cal:196,prot:31,carb:0,fat:7.6,unit:"100g",type:"static"},{id:"f026",name:"Salmon (Cooked)",cal:208,prot:24,carb:0,fat:12,unit:"100g",type:"static"},{id:"f027",name:"Hake (Cooked)",cal:88,prot:17.5,carb:0,fat:1.5,unit:"100g",type:"static"},{id:"f028",name:"Canned Tuna (in Water/Brine)",cal:109,prot:25.5,carb:0,fat:.8,unit:"100g",type:"static"},{id:"f029",name:"Mackerel (Cooked)",cal:262,prot:24,carb:0,fat:18,unit:"100g",type:"static"},{id:"f030",name:"Sardines (Canned in Oil, Drained)",cal:208,prot:25,carb:0,fat:11.5,unit:"100g",type:"static"},{id:"f031",name:"Cod (Cooked)",cal:105,prot:23,carb:0,fat:.9,unit:"100g",type:"static"},{id:"f032",name:"Tilapia (Cooked)",cal:128,prot:26,carb:0,fat:2.7,unit:"100g",type:"static"},{id:"f033",name:"Shrimp (Cooked)",cal:99,prot:24,carb:.2,fat:.3,unit:"100g",type:"static"},{id:"f034",name:"Crab (Cooked)",cal:97,prot:19.4,carb:0,fat:1.8,unit:"100g",type:"static"},{id:"f035",name:"Mussels (Cooked)",cal:172,prot:24,carb:7.4,fat:4.5,unit:"100g",type:"static"},{id:"f036",name:"Trout (Cooked)",cal:190,prot:26,carb:0,fat:8.5,unit:"100g",type:"static"},{id:"f037",name:"Halibut (Cooked)",cal:140,prot:27,carb:0,fat:3,unit:"100g",type:"static"},{id:"f038",name:"Whey Protein Scoop (30g)",cal:120,prot:24,carb:3,fat:1.5,unit:"1 unit",type:"static"},{id:"f039",name:"Whey Protein (Per 100g)",cal:400,prot:80,carb:10,fat:5,unit:"100g",type:"static"},{id:"f040",name:"Casein Protein Scoop (30g)",cal:120,prot:24,carb:3,fat:1,unit:"1 unit",type:"static"},{id:"f041",name:"Protein Bar (Average)",cal:200,prot:20,carb:22,fat:6,unit:"1 unit",type:"static"},{id:"f042",name:"Quest Bar",cal:200,prot:21,carb:21,fat:9,unit:"1 unit",type:"static"},{id:"f043",name:"Mass Gainer Scoop (100g)",cal:380,prot:20,carb:60,fat:6,unit:"1 unit",type:"static"},{id:"f044",name:"Creatine Monohydrate (5g)",cal:0,prot:0,carb:0,fat:0,unit:"1 unit",type:"static"},{id:"f045",name:"Milk (Whole - 3.5% F)",cal:61,prot:3.2,carb:4.7,fat:3.3,unit:"100g",type:"static"},{id:"f046",name:"Milk (Reduced Fat - 2% F)",cal:50,prot:3.4,carb:4.9,fat:2,unit:"100g",type:"static"},{id:"f047",name:"Milk (Skimmed - 0.1% F)",cal:35,prot:3.4,carb:5.1,fat:.1,unit:"100g",type:"static"},{id:"f048",name:"Almond Milk (Unsweetened)",cal:17,prot:.6,carb:.6,fat:1.1,unit:"100g",type:"static"},{id:"f049",name:"Oat Milk",cal:47,prot:1,carb:6.7,fat:1.5,unit:"100g",type:"static"},{id:"f050",name:"Bulgarian Yogurt (2% F)",cal:54,prot:3.2,carb:4.2,fat:2,unit:"100g",type:"static"},{id:"f051",name:"Yogurt (Greek, Plain, Non-Fat)",cal:59,prot:10,carb:3.6,fat:.4,unit:"100g",type:"static"},{id:"f052",name:"Yogurt (Greek, Plain, Full-Fat)",cal:97,prot:9,carb:3.6,fat:5,unit:"100g",type:"static"},{id:"f053",name:"Skyr (Plain, 0% Fat)",cal:61,prot:11,carb:3.7,fat:.2,unit:"100g",type:"static"},{id:"f054",name:"Kefir (Low Fat)",cal:41,prot:3.3,carb:4.5,fat:1,unit:"100g",type:"static"},{id:"f055",name:"Yellow Cheese (Cheddar)",cal:406,prot:24,carb:1.3,fat:33.1,unit:"100g",type:"static"},{id:"f056",name:"Cottage Cheese (2% F)",cal:72,prot:10.5,carb:3.5,fat:2,unit:"100g",type:"static"},{id:"f057",name:"Cottage Cheese (Full Fat)",cal:98,prot:11.1,carb:3.4,fat:4.3,unit:"100g",type:"static"},{id:"f058",name:"Bulgarian White Cheese (Sirene)",cal:276,prot:17,carb:.2,fat:23,unit:"100g",type:"static"},{id:"f059",name:"Feta Cheese (Average)",cal:264,prot:14,carb:4.1,fat:21,unit:"100g",type:"static"},{id:"f060",name:"Low-fat Quark",cal:66,prot:12,carb:4.1,fat:.2,unit:"100g",type:"static"},{id:"f061",name:"Mozzarella Cheese",cal:280,prot:22,carb:3.1,fat:21,unit:"100g",type:"static"},{id:"f062",name:"Parmesan Cheese",cal:431,prot:38,carb:4.1,fat:29,unit:"100g",type:"static"},{id:"f063",name:"Cream Cheese",cal:342,prot:6,carb:5.5,fat:34,unit:"100g",type:"static"},{id:"f064",name:"Olive Oil",cal:884,prot:0,carb:0,fat:100,unit:"100g",type:"static"},{id:"f065",name:"Coconut Oil",cal:862,prot:0,carb:0,fat:100,unit:"100g",type:"static"},{id:"f066",name:"Butter",cal:717,prot:.8,carb:.1,fat:81.1,unit:"100g",type:"static"},{id:"f067",name:"Ghee",cal:900,prot:0,carb:0,fat:100,unit:"100g",type:"static"},{id:"f068",name:"Vegetable Oil",cal:884,prot:0,carb:0,fat:100,unit:"100g",type:"static"},{id:"f069",name:"Avocado Oil",cal:884,prot:0,carb:0,fat:100,unit:"100g",type:"static"},{id:"f070",name:"Almonds (Raw)",cal:579,prot:21.2,carb:21.6,fat:49.9,unit:"100g",type:"static"},{id:"f071",name:"Peanut Butter (Smooth)",cal:588,prot:25,carb:20,fat:50,unit:"100g",type:"static"},{id:"f072",name:"Almond Butter",cal:614,prot:21,carb:18.8,fat:55.5,unit:"100g",type:"static"},{id:"f073",name:"Cashews (Dry Roasted)",cal:553,prot:18,carb:30,fat:44,unit:"100g",type:"static"},{id:"f074",name:"Walnuts (Raw)",cal:654,prot:15.2,carb:13.7,fat:65.2,unit:"100g",type:"static"},{id:"f075",name:"Sunflower Seeds",cal:584,prot:20.8,carb:20,fat:51.5,unit:"100g",type:"static"},{id:"f076",name:"Chia Seeds",cal:486,prot:16.5,carb:42.1,fat:30.7,unit:"100g",type:"static"},{id:"f077",name:"Wholegrain Bread (Slice)",cal:82,prot:4,carb:13.8,fat:1.1,unit:"1 unit",type:"static"},{id:"f078",name:"White Bread (Slice)",cal:75,prot:2.5,carb:14,fat:1,unit:"1 unit",type:"static"},{id:"f079",name:"Sourdough Bread (Slice)",cal:93,prot:3.8,carb:18,fat:.6,unit:"1 unit",type:"static"},{id:"f080",name:"Rye Bread (Slice)",cal:83,prot:2.7,carb:15.5,fat:1.1,unit:"1 unit",type:"static"},{id:"f081",name:"Rice (Cooked, Brown)",cal:112,prot:2.6,carb:23.5,fat:.9,unit:"100g",type:"static"},{id:"f082",name:"Jasmine Rice (Cooked)",cal:129,prot:2.7,carb:28,fat:.3,unit:"100g",type:"static"},{id:"f083",name:"Quinoa (Cooked)",cal:120,prot:4.4,carb:21.3,fat:1.9,unit:"100g",type:"static"},{id:"f084",name:"Couscous (Cooked)",cal:112,prot:3.8,carb:23.2,fat:.2,unit:"100g",type:"static"},{id:"f085",name:"Potatoes (Cooked)",cal:87,prot:1.9,carb:20.1,fat:.1,unit:"100g",type:"static"},{id:"f086",name:"Sweet Potato (Cooked)",cal:90,prot:2,carb:20.7,fat:.1,unit:"100g",type:"static"},{id:"f087",name:"Oats (Dry, Uncooked)",cal:389,prot:16.9,carb:66.3,fat:6.9,unit:"100g",type:"static"},{id:"f088",name:"Instant Oats (Dry)",cal:379,prot:13.2,carb:67.7,fat:6.5,unit:"100g",type:"static"},{id:"f089",name:"Pasta (Cooked, White)",cal:131,prot:5,carb:25.1,fat:1.1,unit:"100g",type:"static"},{id:"f090",name:"Pasta (Cooked, Whole Wheat)",cal:124,prot:5.3,carb:26.5,fat:.5,unit:"100g",type:"static"},{id:"f091",name:"Tortilla Wrap (Medium)",cal:150,prot:4,carb:24,fat:4,unit:"1 unit",type:"static"},{id:"f092",name:"Cornflakes (Dry)",cal:357,prot:7.9,carb:84,fat:.4,unit:"100g",type:"static"},{id:"f093",name:"Granola (Average)",cal:471,prot:10.1,carb:64,fat:20,unit:"100g",type:"static"},{id:"f094",name:"Beans (Kidney, Cooked)",cal:127,prot:8.7,carb:22.8,fat:.5,unit:"100g",type:"static"},{id:"f095",name:"Black Beans (Cooked)",cal:132,prot:8.9,carb:23.7,fat:.5,unit:"100g",type:"static"},{id:"f096",name:"Lentils (Cooked)",cal:116,prot:9,carb:20.1,fat:.4,unit:"100g",type:"static"},{id:"f097",name:"Chickpeas (Cooked)",cal:164,prot:8.9,carb:27.4,fat:2.6,unit:"100g",type:"static"},{id:"f098",name:"Edamame (Cooked)",cal:122,prot:11.9,carb:8.9,fat:5.2,unit:"100g",type:"static"},{id:"f099",name:"Hummus",cal:166,prot:7.9,carb:14.3,fat:9.6,unit:"100g",type:"static"},{id:"f100",name:"Apple (Raw)",cal:52,prot:.3,carb:13.8,fat:.2,unit:"100g",type:"static"},{id:"f101",name:"Banana (Raw)",cal:89,prot:1.1,carb:22.8,fat:.3,unit:"100g",type:"static"},{id:"f102",name:"Orange (Raw)",cal:47,prot:.9,carb:11.8,fat:.1,unit:"100g",type:"static"},{id:"f103",name:"Strawberries (Raw)",cal:32,prot:.7,carb:7.7,fat:.3,unit:"100g",type:"static"},{id:"f104",name:"Blueberries (Raw)",cal:57,prot:.7,carb:14.5,fat:.3,unit:"100g",type:"static"},{id:"f105",name:"Raspberries (Raw)",cal:52,prot:1.2,carb:11.9,fat:.7,unit:"100g",type:"static"},{id:"f106",name:"Grapes (Raw)",cal:69,prot:.7,carb:18.1,fat:.2,unit:"100g",type:"static"},{id:"f107",name:"Watermelon (Raw)",cal:30,prot:.6,carb:7.6,fat:.2,unit:"100g",type:"static"},{id:"f108",name:"Pineapple (Raw)",cal:50,prot:.5,carb:13.1,fat:.1,unit:"100g",type:"static"},{id:"f109",name:"Mango (Raw)",cal:60,prot:.8,carb:15,fat:.4,unit:"100g",type:"static"},{id:"f110",name:"Peach (Raw)",cal:39,prot:.9,carb:9.5,fat:.3,unit:"100g",type:"static"},{id:"f111",name:"Pear (Raw)",cal:57,prot:.4,carb:15.2,fat:.1,unit:"100g",type:"static"},{id:"f112",name:"Kiwi (Raw)",cal:61,prot:1.1,carb:14.7,fat:.5,unit:"100g",type:"static"},{id:"f113",name:"Cherries (Raw)",cal:50,prot:1,carb:12.2,fat:.3,unit:"100g",type:"static"},{id:"f114",name:"Avocado (Raw)",cal:160,prot:2,carb:8.5,fat:14.7,unit:"100g",type:"static"},{id:"f115",name:"Grapefruit (Raw)",cal:42,prot:.8,carb:10.7,fat:.1,unit:"100g",type:"static"},{id:"f116",name:"Pomegranate (Raw)",cal:83,prot:1.7,carb:18.7,fat:1.2,unit:"100g",type:"static"},{id:"f117",name:"Dates (Dried)",cal:282,prot:2.5,carb:75,fat:.4,unit:"100g",type:"static"},{id:"f118",name:"Raisins (Dried)",cal:299,prot:3.1,carb:79.2,fat:.5,unit:"100g",type:"static"},{id:"f119",name:"Broccoli (Cooked)",cal:35,prot:2.4,carb:7.2,fat:.4,unit:"100g",type:"static"},{id:"f120",name:"Spinach (Cooked)",cal:23,prot:2.9,carb:3.8,fat:.3,unit:"100g",type:"static"},{id:"f121",name:"Carrots (Raw)",cal:41,prot:.9,carb:9.6,fat:.2,unit:"100g",type:"static"},{id:"f122",name:"Bell Peppers (Raw)",cal:26,prot:1,carb:6,fat:.3,unit:"100g",type:"static"},{id:"f123",name:"Tomato (Raw)",cal:18,prot:.9,carb:3.9,fat:.2,unit:"100g",type:"static"},{id:"f124",name:"Cucumber (Raw)",cal:15,prot:.7,carb:3.6,fat:.1,unit:"100g",type:"static"},{id:"f125",name:"Cauliflower (Cooked)",cal:23,prot:1.8,carb:4.1,fat:.5,unit:"100g",type:"static"},{id:"f126",name:"Zucchini (Cooked)",cal:17,prot:1.2,carb:3.1,fat:.3,unit:"100g",type:"static"},{id:"f127",name:"Kale (Raw)",cal:35,prot:2.9,carb:4.4,fat:1.5,unit:"100g",type:"static"},{id:"f128",name:"Onion (Raw)",cal:40,prot:1.1,carb:9.3,fat:.1,unit:"100g",type:"static"},{id:"f129",name:"Mushrooms (Cooked)",cal:28,prot:3.3,carb:5.3,fat:.5,unit:"100g",type:"static"},{id:"f130",name:"Tofu (Firm)",cal:76,prot:8,carb:1.9,fat:4.8,unit:"100g",type:"static"},{id:"f131",name:"Tofu (Silken)",cal:55,prot:5,carb:2,fat:2.7,unit:"100g",type:"static"},{id:"f132",name:"Tempeh",cal:193,prot:20.3,carb:7.6,fat:10.8,unit:"100g",type:"static"},{id:"f133",name:"Seitan",cal:370,prot:75,carb:14,fat:1.9,unit:"100g",type:"static"},{id:"f134",name:"Ketchup",cal:112,prot:1.2,carb:27.4,fat:.1,unit:"100g",type:"static"},{id:"f135",name:"Mayonnaise (Full Fat)",cal:680,prot:1.1,carb:.6,fat:75,unit:"100g",type:"static"},{id:"f136",name:"Mustard (Yellow)",cal:60,prot:3.7,carb:5.3,fat:3.3,unit:"100g",type:"static"},{id:"f137",name:"BBQ Sauce",cal:172,prot:1,carb:41,fat:.6,unit:"100g",type:"static"},{id:"f138",name:"Soy Sauce",cal:53,prot:5.6,carb:4.9,fat:.1,unit:"100g",type:"static"},{id:"f139",name:"Hot Sauce (Sriracha)",cal:93,prot:2,carb:20,fat:1,unit:"100g",type:"static"},{id:"f140",name:"Salsa (Tomato)",cal:36,prot:1.5,carb:8,fat:.2,unit:"100g",type:"static"},{id:"f141",name:"Ranch Dressing",cal:477,prot:1.6,carb:6.7,fat:49.4,unit:"100g",type:"static"},{id:"f142",name:"Dark Chocolate (70-85% Cacao)",cal:598,prot:7.8,carb:45.9,fat:42.6,unit:"100g",type:"static"},{id:"f143",name:"Milk Chocolate",cal:535,prot:7.6,carb:59.4,fat:29.7,unit:"100g",type:"static"},{id:"f144",name:"White Chocolate",cal:539,prot:5.9,carb:59.2,fat:32.1,unit:"100g",type:"static"},{id:"f145",name:"Honey",cal:304,prot:.3,carb:82.4,fat:0,unit:"100g",type:"static"},{id:"f146",name:"Maple Syrup",cal:260,prot:0,carb:67,fat:.1,unit:"100g",type:"static"},{id:"f147",name:"Ice Cream (Vanilla)",cal:207,prot:3.5,carb:23.6,fat:11,unit:"100g",type:"static"},{id:"f148",name:"Cookies (Chocolate Chip)",cal:49,prot:.5,carb:6.4,fat:2.3,unit:"1 unit",type:"static"},{id:"f149",name:"Brownie (Average)",cal:112,prot:1.5,carb:12,fat:7,unit:"1 unit",type:"static"},{id:"f150",name:"Donut (Glazed)",cal:269,prot:4,carb:31,fat:15,unit:"1 unit",type:"static"},{id:"f151",name:"Doner Kebab Meat (Small, 85g)",cal:320,prot:20,carb:0,fat:26.7,unit:"1 unit",type:"static"},{id:"f152",name:"Pizza Slice (Pepperoni)",cal:298,prot:12.2,carb:33.6,fat:13.2,unit:"1 unit",type:"static"},{id:"f153",name:"Pizza Slice (Margherita)",cal:271,prot:12,carb:33,fat:10,unit:"1 unit",type:"static"},{id:"f154",name:"Banitsa (with Feta/Sirene)",cal:421,prot:13.3,carb:36.4,fat:24.7,unit:"100g",type:"static"},{id:"f155",name:"French Fries (Fried)",cal:312,prot:3.4,carb:41.4,fat:14.7,unit:"100g",type:"static"},{id:"f156",name:"Pastrami",cal:147,prot:22,carb:.4,fat:6,unit:"100g",type:"static"},{id:"f157",name:"Cheeseburger (Fast Food)",cal:303,prot:15.5,carb:32.8,fat:12.7,unit:"1 unit",type:"static"},{id:"f158",name:"Big Mac",cal:540,prot:25,carb:45,fat:28,unit:"1 unit",type:"static"},{id:"f159",name:"Chicken Nuggets (6 pieces)",cal:270,prot:15,carb:16,fat:16,unit:"1 unit",type:"static"},{id:"f160",name:"Fried Chicken Drumstick",cal:120,prot:11,carb:2,fat:7,unit:"1 unit",type:"static"},{id:"f161",name:"Burrito (Bean & Cheese)",cal:380,prot:15,carb:55,fat:11,unit:"1 unit",type:"static"},{id:"f162",name:"Taco (Beef)",cal:210,prot:9,carb:13,fat:13,unit:"1 unit",type:"static"},{id:"f163",name:"Sushi Roll (California Roll, 8 pieces)",cal:255,prot:9,carb:38,fat:7,unit:"1 unit",type:"static"},{id:"f164",name:"Spring Roll (Fried)",cal:110,prot:3,carb:12,fat:6,unit:"1 unit",type:"static"},{id:"f165",name:"Coffee (Black, No Sugar)",cal:2,prot:.1,carb:0,fat:0,unit:"100g",type:"static"},{id:"f166",name:"Coffee (with Milk)",cal:7,prot:.4,carb:.7,fat:.2,unit:"100g",type:"static"},{id:"f167",name:"Latte (8oz)",cal:120,prot:6,carb:11,fat:6,unit:"1 unit",type:"static"},{id:"f168",name:"Cappuccino (8oz)",cal:80,prot:4,carb:6,fat:4,unit:"1 unit",type:"static"},{id:"f169",name:"Green Tea (Unsweetened)",cal:1,prot:0,carb:0,fat:0,unit:"100g",type:"static"},{id:"f170",name:"Orange Juice (100%)",cal:45,prot:.7,carb:10.4,fat:.2,unit:"100g",type:"static"},{id:"f171",name:"Apple Juice (100%)",cal:46,prot:.1,carb:11.3,fat:.1,unit:"100g",type:"static"},{id:"f172",name:"Coca Cola",cal:42,prot:0,carb:10.6,fat:0,unit:"100g",type:"static"},{id:"f173",name:"Red Bull",cal:45,prot:.4,carb:11,fat:0,unit:"100g",type:"static"},{id:"f174",name:"Gatorade",cal:25,prot:0,carb:6,fat:0,unit:"100g",type:"static"},{id:"f175",name:"Beer (Regular)",cal:43,prot:.5,carb:3.6,fat:0,unit:"100g",type:"static"},{id:"f176",name:"Red Wine",cal:85,prot:.1,carb:2.6,fat:0,unit:"100g",type:"static"},{id:"f177",name:"White Wine",cal:82,prot:.1,carb:2.6,fat:0,unit:"100g",type:"static"},{id:"f178",name:"Vodka (40% ABV)",cal:231,prot:0,carb:0,fat:0,unit:"100g",type:"static"}],t=async()=>{const t=await new Promise((e,t)=>{window.DB?DB.transact("customFoods","readonly").then(t=>{const a=t.getAll();a.onsuccess=()=>e(a.result),a.onerror=t=>{console.warn("Error fetching custom foods:",t),e([])}}).catch(t=>{console.warn("DB Transact failed for custom foods:",t),e([])}):e([])});return[...e,...t]};return{getAllFoods:t,getFoodById:async e=>(await t()).find(t=>t.id===e),searchFoods:async(e,a="ALL")=>{const n=await t(),o=e.toLowerCase(),r=n.filter(e=>e.name.toLowerCase().includes(o));if("ALL"===a)return r.sort((e,t)=>e.name.localeCompare(t.name));const i=a.toLowerCase().slice(0,4);return r.sort((e,t)=>{const a=parseFloat(e[i])||0;return(parseFloat(t[i])||0)-a})},addCustomFood:e=>new Promise((t,a)=>{e.id="c"+Date.now(),e.type="custom",DB.transact("customFoods","readwrite").then(n=>{const o=n.add(e);o.onsuccess=()=>t(e.id),o.onerror=e=>a(e.target.error)}).catch(a)}),deleteCustomFood:e=>new Promise((t,a)=>{DB.transact("customFoods","readwrite").then(n=>{const o=n.delete(e);o.onsuccess=()=>t(!0),o.onerror=e=>a(e.target.error)}).catch(a)})}})(),AddCustomFoodView={render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'logFood\'); return false;" class="header-action">\n                    CANCEL\n                </a>\n                <h2 class="view-title">Add Custom Food</h2>\n                <a href="#" id="btn-save-custom-food" class="header-action">\n                    SAVE\n                </a>\n            </div>\n\n            <div class="custom-food-form" style="padding: 20px;">\n                <div class="input-group">\n                    <label for="food-name">Food Name</label>\n                    <input type="text" id="food-name" placeholder="e.g., My Protein Shake">\n                </div>\n\n                <div class="input-group" style="display: flex; justify-content: space-between; align-items: flex-end;">\n                    <div style="flex-grow: 1;">\n                        <label for="base-unit">Base Unit</label>\n                        <select id="base-unit">\n                            <option value="Grams (g)">Grams (g)</option>\n                            <option value="Milliliters (ml)">Milliliters (ml)</option>\n                            <option value="Units">Units</option>\n                        </select>\n                    </div>\n                    <div style="width: 40%; margin-left: 10px;">\n                        <label for="base-amount">Base Amount (in g/ml/units)</label>\n                        <input type="number" id="base-amount" value="100" style="font-size: 1rem;">\n                    </div>\n                </div>\n\n                <h3 style="margin-top: 30px;">Macros per 100g/unit (Standardized)</h3>\n\n                <div class="input-group">\n                    <label for="macro-calories">Calories (kcal)</label>\n                    <input type="number" id="macro-calories">\n                </div>\n\n                <div class="input-group">\n                    <label for="macro-protein">Protein (g)</label>\n                    <input type="number" id="macro-protein">\n                </div>\n\n                <div class="input-group">\n                    <label for="macro-carbs">Carbs (g)</label>\n                    <input type="number" id="macro-carbs">\n                </div>\n\n                <div class="input-group">\n                    <label for="macro-fats">Fats (g)</label>\n                    <input type="number" id="macro-fats">\n                </div>\n            </div>\n        ',initEvents:()=>{document.getElementById("btn-save-custom-food").addEventListener("click",e=>{e.preventDefault(),(async()=>{const e=document.getElementById("food-name").value.trim(),t=document.getElementById("base-unit").value,a=parseFloat(document.getElementById("base-amount").value),n=parseFloat(document.getElementById("macro-calories").value),o=parseFloat(document.getElementById("macro-protein").value),r=parseFloat(document.getElementById("macro-carbs").value),i=parseFloat(document.getElementById("macro-fats").value);if(!e||isNaN(a)||a<=0)return void await showModal("Validation Error","Please enter a valid food name and base amount (e.g., 100).");const s={name:e,unit:`${a} ${t}`,cal:isNaN(n)?0:n,prot:isNaN(o)?0:o,carb:isNaN(r)?0:r,fat:isNaN(i)?0:i};try{await FoodData.addCustomFood(s),await showModal("Success!",`Successfully added custom food: ${e}`),renderView("logFood")}catch(e){console.error("Error saving custom food:",e),await showModal("Database Error","Error saving custom food to database.")}})()})}},CreateNewExerciseView=(()=>{let e=null,t="";const a=ExerciseData.MUSCLE_GROUPS.map(e=>`<option value="${e.toLowerCase()}">${e}</option>`).join(""),n=ExerciseData.EQUIPMENT_TYPES.map(e=>`<option value="${e.toLowerCase()}">${e}</option>`).join("");return{render:o=>(e=o.workoutId,t=o.name||"",`\n            <div class="view-header">\n                <a href="#" onclick="renderView('editWorkoutDetail', ${e}); return false;" class="header-action">\n                    CANCEL\n                </a>\n                <h2 class="view-title">Create New Exercise</h2>\n                <a href="#" id="btn-save-exercise" class="header-action">\n                    SAVE\n                </a>\n            </div>\n\n            <div class="custom-exercise-form" style="padding: 20px;">\n                <div class="input-group">\n                    <label for="exercise-name">Exercise Name</label>\n                    <input type="text" id="exercise-name" placeholder="e.g., My Custom Press" value="${t}">\n                </div>\n\n                <div class="input-group">\n                    <label for="muscle-group">Muscle Group</label>\n                    <select id="muscle-group" style="font-size: 1.2rem;">\n                        ${a}\n                    </select>\n                </div>\n\n                <div class="input-group">\n                    <label for="equipment-type">Equipment</label>\n                    <select id="equipment-type" style="font-size: 1.2rem;">\n                        ${n}\n                    </select>\n                </div>\n\n            </div>\n        `),initEvents:()=>{document.getElementById("btn-save-exercise").addEventListener("click",t=>{t.preventDefault(),(async()=>{const t=document.getElementById("exercise-name").value.trim(),a=document.getElementById("muscle-group").value,n=document.getElementById("equipment-type").value;if(!t)return void await showModal("Validation Error","Please enter a valid exercise name.","alert");const o={name:t,muscle:a,equipment:n,type:"custom"};try{const t=await DataService.saveCustomExercise(o);await DataService.addExerciseToWorkout(e,t),await showModal("Success",`Custom exercise "${t.name}" created and added to workout.`,"alert"),renderView("editWorkoutDetail",e)}catch(e){console.error("Error saving custom exercise:",e),await showModal("Error","Failed to save or add the new exercise.","alert")}})()})}}})(),DateRangeView=(()=>{let e="home";const t=e=>{const t=new Date(e);if(isNaN(t))return"";return`${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}/${t.getFullYear()}`},a=e=>{const t=e.split("/");if(3!==t.length)return null;const a=new Date(`${t[0]}/${t[1]}/${t[2]}`);return isNaN(a)||a.getFullYear()!==parseInt(t[2],10)?null:a},n={render:a=>{e=a&&a.parent?a.parent:"FoodHistoryView";const n=a&&a.start?t(a.start):t(Date.now()),o=a&&a.end?t(a.end):t(Date.now());return`\n            <div class="view-header">\n                <a href="#" onclick="renderView('${e}'); return false;" class="header-action">\n                    CANCEL\n                </a>\n                <h2 class="view-title">Select Date Range</h2>\n                <a href="#" id="btn-confirm-range" class="header-action" style="color: var(--color-primary-green);">\n                    CONFIRM\n                </a>\n            </div>\n\n            <div style="padding: 20px;">\n                <div class="input-group">\n                    <label for="start-date-input">Start Date</label>\n                    <input type="text" id="start-date-input" placeholder="MM/DD/YYYY" value="${n}">\n                    </div>\n\n                <div class="input-group">\n                    <label for="end-date-input">End Date</label>\n                    <input type="text" id="end-date-input" placeholder="MM/DD/YYYY" value="${o}">\n                    </div>\n\n            </div>\n        `},initEvents:()=>{document.getElementById("btn-confirm-range").addEventListener("click",t=>{t.preventDefault(),(async()=>{const t=document.getElementById("start-date-input").value,n=document.getElementById("end-date-input").value,o=a(t),r=a(n);if(o&&r)if(o.getTime()>r.getTime())await showModal("Date Error","Start date cannot be after end date.");else{if(r.setHours(23,59,59,999),!e||!window[e]||!window[e].setCustomRange)return await showModal("Error","Custom range feature initialization failed. Returning home.","alert"),void renderView("home");window[e].setCustomRange(o.getTime(),r.getTime()),renderView(e,{rangeType:"CUSTOM",start:o.getTime(),end:r.getTime()})}else await showModal("Date Error","Please enter both dates in MM/DD/YYYY format.")})()})}};return"undefined"!=typeof window&&(window.DateRangeView=n),n})(),EditWorkoutDetailView=(()=>{let e=null;const t=async t=>{const a=parseInt(t.target.dataset.index,10),n=t.target.dataset.field,o=t.target.value.trim();if(e&&e.exercises[a]){if("sets"===n&&o.length>0&&(isNaN(o)||parseInt(o,10)<=0))return t.target.value=e.exercises[a][n],void await showModal("Validation","Sets must be a positive number.","alert");e.exercises[a][n]=o.length>0?o:null;try{await DataService.updateWorkout(e)}catch(t){console.error("Error updating sets/reps:",t),await showModal("Error","Failed to save exercise details.","alert")}}},a=async t=>{try{const o=await DataService.getWorkoutById(t);if(!o)return void(document.getElementById("edit-workout-container").innerHTML='\n                    <h2 style="padding: 20px; color: var(--color-red);">Workout Not Found</h2>\n                ');e=o,document.getElementById("view-title").textContent=o.name,document.getElementById("exercise-list-container").innerHTML=(a=o.exercises)&&0!==a.length?a.map((e,t)=>{const a=void 0!==e.sets?e.sets:"",n=void 0!==e.reps?e.reps:"";return`\n            <div class="card exercise-item" data-index="${t}" style="margin-bottom: 15px; padding: 15px;">\n                <div style="display: flex; justify-content: space-between; align-items: center;">\n                    <h3 style="margin: 0; font-size: 1.2rem;">${e.name}</h3>\n                    <i class="fas fa-trash delete-exercise-btn" data-index="${t}" style="color: var(--color-red); cursor: pointer;"></i>\n                </div>\n\n                <div style="display: flex; gap: 20px; margin-top: 15px;">\n                    <div class="input-group" style="flex: 1; border-bottom: none; margin-bottom: 0;">\n                        <label style="color: var(--color-text-secondary); font-size: 0.8rem;">Sets</label>\n                        <input type="number" data-index="${t}" data-field="sets"\n                                class="sets-reps-input" value="${a}"\n                                placeholder="e.g., 3"\n                                style="font-size: 1rem; padding: 5px 0; border-bottom: 1px solid var(--color-border);">\n                    </div>\n                    <div class="input-group" style="flex: 1; border-bottom: none; margin-bottom: 0;">\n                        <label style="color: var(--color-text-secondary); font-size: 0.8rem;">Reps (e.g., 10 or 8-12)</label>\n                        <input type="text" data-index="${t}" data-field="reps"\n                                class="sets-reps-input" value="${n}"\n                                placeholder="e.g., 8-12"\n                                style="font-size: 1rem; padding: 5px 0; border-bottom: 1px solid var(--color-border);">\n                    </div>\n                </div>\n            </div>\n        `}).join(""):'\n                <div style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px; border-bottom: 1px solid var(--color-border);">\n                    <p>No exercises added yet.</p>\n                </div>\n            ',n()}catch(e){console.error("Error loading workout details:",e),document.getElementById("edit-workout-container").innerHTML='\n                <h2 style="padding: 20px; color: var(--color-red);">Failed to Load Workout</h2>\n            '}var a},n=()=>{document.querySelectorAll(".delete-exercise-btn").forEach(t=>{t.addEventListener("click",()=>{(async t=>{if(await showModal("Remove Exercise?","Are you sure you want to remove this exercise from the workout?","confirm")){if(!e||!e.exercises)return;e.exercises.splice(t,1);try{await DataService.updateWorkout(e),a(e.id)}catch(e){console.error("Error deleting exercise from workout:",e),await showModal("Error","Failed to remove exercise from workout.","alert")}}})(parseInt(t.dataset.index,10))})}),document.querySelectorAll(".sets-reps-input").forEach(e=>{e.addEventListener("blur",t)})},o=()=>{e&&renderView("selectExercise",e.id)};return{render:e=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'manageWorkouts\'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title" id="view-title" style="margin-left: 15px;">Loading...</h2>\n                <div></div>\n            </div>\n\n            <div id="edit-workout-container" style="padding: 15px;">\n\n                <div class="button-group" style="gap: 15px; margin-bottom: 20px;">\n                    <button id="btn-add-from-database" class="btn" style="background-color: var(--color-primary-blue); color: var(--color-text); margin: 0 auto; width: 100%;">\n                        <i class="fas fa-search"></i> &nbsp; ADD EXERCISE\n                    </button>\n                    </div>\n\n                <h3 style="margin-top: 0; margin-bottom: 10px;">Exercises</h3>\n\n                <div id="exercise-list-container" style="margin-bottom: 20px;">\n                    <p style="text-align: center; color: var(--color-text-secondary);">Loading exercise list...</p>\n                </div>\n\n            </div>\n        ',initEvents:e=>{a(e),document.getElementById("btn-add-from-database").addEventListener("click",o)}}})(),FoodHistoryView=(()=>{let e="ALL",t=0,a=(new Date).setFullYear((new Date).getFullYear()+100);const n=e=>{const t=new Date(e);return`${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}/${t.getFullYear()}`},o=e=>{const t=e.split("/");if(3!==t.length)return null;const a=new Date(`${t[2]}/${t[0]}/${t[1]}`);return isNaN(a)||a.getFullYear()!==parseInt(t[2],10)?null:a},r=()=>{const e=`\n      <div style="padding: 20px;">\n        <p style="margin-top: 0; color: var(--color-text-secondary);">\n          Select the date range for filtering the food log.\n        </p>\n        <div class="input-group">\n          <label for="modal-start-date-input">Start Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-start-date-input" placeholder="MM/DD/YYYY" value="${n(t||Date.now())}">\n        </div>\n        <div class="input-group">\n          <label for="modal-end-date-input">End Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-end-date-input" placeholder="MM/DD/YYYY" value="${n(a||Date.now())}">\n        </div>\n      </div>\n    `;window.showModal("Select Custom Date Range",e,"confirm").then(async e=>{if(e){const e=document.getElementById("modal-start-date-input").value,t=document.getElementById("modal-end-date-input").value,a=o(e),n=o(t);if(!a||!n||a.getTime()>n.getTime())return await showModal("Error","Invalid dates. Please try again.","alert"),void r();n.setHours(23,59,59,999),i("CUSTOM",a.getTime(),n.getTime())}})},i=async(o,r=null,i=null)=>{if(e=o,document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),"CUSTOM"!==o){const e=document.getElementById(`filter-range-${o.toLowerCase()}`);e&&e.classList.add("active")}let c,d;if("CUSTOM"===o&&r&&i)c=r,d=i;else if("ALL"===o)c=0,d=(new Date).setFullYear((new Date).getFullYear()+100);else{const e=DataService.getRangeDates(o);c=e.start,d=e.end}t=c,a=d;const u=document.getElementById("btn-select-custom-range");u&&("CUSTOM"===o?(u.innerHTML=`<i class="fas fa-calendar-alt"></i> &nbsp; ${n(t)} - ${n(a)}`,u.style.border="1px solid var(--color-primary-green)"):(u.innerHTML='<i class="fas fa-calendar-alt"></i> &nbsp; Select Custom Range',u.style.border="none"));const p=document.getElementById("history-table-container");p&&(p.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">Loading data...</p>');try{const{entries:e,totals:n}=await DataService.getLogEntriesByRange(t,a);p&&(p.innerHTML=s(e,n),l())}catch(e){console.error("Error loading history:",e),p&&(p.innerHTML='<p style="text-align: center; color: var(--color-red);">There is no food data.</p>')}},s=(e,t)=>{if(0===e.length)return'<div style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">\n                        <p>No food logged in this range.</p>\n                    </div>';return`\n            <div class="table-scroll-wrapper" style="overflow-x: auto; padding: 0 15px;">\n                <table class="history-table" style="min-width: 600px; width: 100%; border-collapse: collapse; margin-bottom: 20px;">\n                    <thead>\n                        <tr style="border-bottom: 1px solid var(--color-border);">\n                            <th style="text-align: left; padding: 10px;">Date</th>\n                            <th style="text-align: left; padding: 10px;">Food</th>\n                            <th style="text-align: left; padding: 10px;">Protein</th>\n                            <th style="text-align: left; padding: 10px;">Carbs</th>\n                            <th style="text-align: left; padding: 10px;">Fat</th>\n                            <th style="text-align: left; padding: 10px;">Cost</th>\n                            <th style="text-align: center; padding: 10px; width: 70px;">Actions</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${e.map(e=>`\n            <tr>\n                <td>${e.date}</td>\n                <td>${e.foodName}</td>\n                <td>${e.totalProtein.toFixed(1)}g</td>\n                <td>${e.totalCarbs.toFixed(1)}g</td>\n                <td>${e.totalFats.toFixed(1)}g</td>\n                <td>$${e.price.toFixed(2)}</td>\n                <td><i class="fas fa-trash delete-history-entry" data-id="${e.id}" style="color: var(--color-red); cursor: pointer;"></i></td>\n            </tr>\n        `).join("")}\n                        ${`\n            <tr class="totals-row" style="font-weight: bold; background-color: var(--color-card);">\n                <td>Totals:</td>\n                <td></td>\n                <td>${t.protein.toFixed(1)}g</td>\n                <td>${t.carbs.toFixed(1)}g</td>\n                <td>${t.fat.toFixed(1)}g</td>\n                <td>$${t.cost.toFixed(2)}</td>\n                <td></td>\n            </tr>\n        `}\n                    </tbody>\n                </table>\n            </div>\n\n            <div class="danger-zone card" style="margin: 0 15px 20px;">\n                <h3 style="color: var(--color-red); margin-top: 0;">Danger Zone</h3>\n                <button id="btn-reset-history" class="btn btn-danger" style="width: 100%;">RESET ALL FOOD HISTORY</button>\n            </div>\n        `},l=()=>{document.querySelectorAll(".delete-history-entry").forEach(n=>{n.addEventListener("click",n=>{(async n=>{await showModal("Delete Entry?","Are you sure you want to delete this specific log entry?","confirm")&&(await DataService.deleteLogEntry(parseInt(n)),i(e,t,a))})(n.target.getAttribute("data-id"))})}),document.getElementById("btn-reset-history").addEventListener("click",async()=>{await showModal("DANGER ZONE","Are you ABSOLUTELY sure you want to delete ALL food history? This cannot be undone.","confirm")&&(await DataService.resetFoodHistory(),i("ALL"))})},c=()=>{document.getElementById("filter-range-all").addEventListener("click",()=>i("ALL")),document.getElementById("filter-range-week").addEventListener("click",()=>i("WEEK")),document.getElementById("filter-range-month").addEventListener("click",()=>i("MONTH")),document.getElementById("filter-range-year").addEventListener("click",()=>i("YEAR")),document.getElementById("btn-select-custom-range").addEventListener("click",r),document.getElementById("btn-toggle-export").addEventListener("click",()=>{document.getElementById("export-select-modal").style.display="flex"}),document.getElementById("btn-export-modal-csv").addEventListener("click",()=>(async()=>{const{entries:n,totals:o}=await DataService.getLogEntriesByRange(t,a);let r="Date,Food,Amount,Unit,Store,Protein (g),Carbs (g),Fats (g),Calories,Cost ($)\n";n.forEach(e=>{const t="manual"===e.priceType?"Manual/Other":"Saved Price Record";r+=`${e.date},"${e.foodName}",${e.amount},g,${t},${e.totalProtein.toFixed(1)},${e.totalCarbs.toFixed(1)},${e.totalFats.toFixed(1)},${e.totalCalories},${e.price.toFixed(2)}\n`});const i=n.reduce((e,t)=>e+t.totalCalories,0);r+=`TOTALS,,,,,${o.protein.toFixed(1)},${o.carbs.toFixed(1)},${o.fat.toFixed(1)},${i},${o.cost.toFixed(2)}\n`;const s=new Blob([r],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(s),c=document.createElement("a");c.href=l;const d=new Date,u=`${d.getMonth()+1}-${d.getDate()}-${d.getFullYear()}`,p=`MacroLog_${"CUSTOM"===e?"CustomRange":e}_${u}`;c.download=`${p}.csv`,c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l),await showModal("Export Complete",`Exported history as ${"csv".toUpperCase()}.`),document.getElementById("export-select-modal").style.display="none"})()),document.getElementById("btn-cancel-export-modal").addEventListener("click",()=>{document.getElementById("export-select-modal").style.display="none"})};return window.FoodHistoryView={render:e=>'\n            <div class="view-header" style="border-bottom: none; padding-bottom: 0;">\n                <a href="#" onclick="renderView(\'home\'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title" style="margin-left: 15px;">Food History Log</h2>\n                <div>\n                    <i id="btn-toggle-export" class="fas fa-cloud-download-alt fa-lg" style="color: var(--color-text); cursor: pointer; margin-right: 15px;"></i>\n                    <i class="fas fa-cloud-upload-alt fa-lg" style="color: var(--color-text); cursor: pointer;"></i>\n                </div>\n            </div>\n\n            <div class="category-tabs" style="padding: 0 0 10px 0;">\n                <button id="filter-range-all" class="tab-button active">ALL</button>\n                <button id="filter-range-week" class="tab-button">WEEK</button>\n                <button id="filter-range-month" class="tab-button">MONTH</button>\n                <button id="filter-range-year" class="tab-button">YEAR</button>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <button id="btn-select-custom-range" class="btn" style="background-color: var(--color-card); color: var(--color-text); margin-bottom: 20px; justify-content: flex-start; border: 1px solid transparent;">\n                    <i class="fas fa-calendar-alt"></i> &nbsp; Select Custom Range\n                </button>\n            </div>\n\n            <div id="history-table-container">\n                <p style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">Loading history data...</p>\n            </div>\n\n            <div style="height: 60px;"></div>\n            \n            <div id="export-select-modal" class="modal-overlay">\n                <div class="modal-content" style="max-width: 350px;">\n                    <h3 style="margin-top: 0;">Select Export Format</h3>\n                    <div class="button-group" style="gap: 5px;">\n                        <button id="btn-export-modal-csv" class="btn" style="background-color: var(--color-primary-green);">CSV (.csv)</button>\n                    </div>\n                    <div style="text-align: right; margin-top: 15px;">\n                        <button id="btn-cancel-export-modal" class="btn" style="background: none; border: none; color: var(--color-text-secondary); width: auto; padding: 5px 10px;">Cancel</button>\n                    </div>\n                </div>\n            </div>\n        \n        ',initEvents:e=>{e&&"CUSTOM"===e.rangeType?i("CUSTOM",e.start,e.end):i("ALL"),c()},setCustomRange:(e,t)=>{i("CUSTOM",e,t)}},window.FoodHistoryView})(),GoalsView={render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'home\'); return false;" class="header-action">\n                    CANCEL\n                </a>\n                <h2 class="view-title">Set Your Goals</h2>\n                <a href="#" id="btn-save-goals" class="header-action">\n                    SAVE\n                </a>\n            </div>\n\n            <div class="goals-form" style="padding: 20px;">\n                <p style="text-align: center; color: var(--color-text-secondary);" id="goals-loading-message">Loading goals...</p>\n                <div class="input-group">\n                    <label for="goal-calories">Calories</label>\n                    <input type="number" id="goal-calories" value="" disabled>\n                </div>\n\n                <div class="input-group">\n                    <label for="goal-protein">Protein (g)</label>\n                    <input type="number" id="goal-protein" value="" disabled>\n                </div>\n\n                <div class="input-group">\n                    <label for="goal-carbs">Carbs (g)</label>\n                    <input type="number" id="goal-carbs" value="" disabled>\n                </div>\n\n                <div class="input-group">\n                    <label for="goal-fats">Fats (g)</label>\n                    <input type="number" id="goal-fats" value="" disabled>\n                </div>\n\n                <div style="text-align: center; color: var(--color-text-secondary); padding-top: 50px;">\n                    <p>Goal setting functionality is active.</p>\n                </div>\n            </div>\n        ',initEvents:()=>{(async()=>{const e=await DataService.getGoals();document.getElementById("goal-calories").value=e.calories,document.getElementById("goal-protein").value=e.protein,document.getElementById("goal-carbs").value=e.carbs,document.getElementById("goal-fats").value=e.fats})().then(()=>{document.getElementById("goals-loading-message").style.display="none",document.getElementById("goal-calories").removeAttribute("disabled"),document.getElementById("goal-protein").removeAttribute("disabled"),document.getElementById("goal-carbs").removeAttribute("disabled"),document.getElementById("goal-fats").removeAttribute("disabled")}).catch(async e=>{console.error("Failed to load goals:",e),await showModal("Load Error","Could not load goals from database.")}),document.getElementById("btn-save-goals").addEventListener("click",e=>{e.preventDefault(),(async()=>{const e={calories:parseInt(document.getElementById("goal-calories").value,10)||0,protein:parseInt(document.getElementById("goal-protein").value,10)||0,carbs:parseInt(document.getElementById("goal-carbs").value,10)||0,fats:parseInt(document.getElementById("goal-fats").value,10)||0};try{await DataService.setGoals(e),renderView("home")}catch(e){console.error("Failed to save goals:",e),await showModal("Save Error","Could not save goals to database.")}})()})}},HomeView=(()=>{const e=()=>{document.querySelectorAll(".logged-food-wrapper").forEach(e=>{const t=e.querySelector(".swipe-content");let a=0,n=0;const o=e=>{a=e,document.querySelectorAll(".swipe-content").forEach(e=>e.style.transform="translateX(0px)")};t.addEventListener("mousedown",e=>o(e.clientX)),t.addEventListener("touchstart",e=>o(e.touches[0].clientX));const r=e=>{n=e-a,n<0?(n=Math.max(-140,n),t.style.transform=`translateX(${n}px)`):n>0&&(t.style.transform="translateX(0px)")};document.addEventListener("mousemove",e=>{0!==a&&r(e.clientX)}),document.addEventListener("touchmove",e=>{0!==a&&r(e.touches[0].clientX)});const i=()=>{0!==a&&(t.style.transform=n<-70?"translateX(-140px)":"translateX(0px)",a=0,n=0)};document.addEventListener("mouseup",i),document.addEventListener("touchend",i)}),document.querySelectorAll(".action-btn").forEach(e=>{e.addEventListener("click",t=>{const a=e.getAttribute("data-action"),n=e.getAttribute("data-id");"delete"===a?(async e=>{await showModal("Delete Entry?","Are you sure you want to delete this log entry?","confirm")&&(await DataService.deleteLogEntry(parseInt(e)),renderView("home"))})(n):"edit"===a&&(e=>{renderView("logDetail",{entryId:parseInt(e)})})(n)})})},t=async()=>{const t=await DataService.getGoals(),a=await DataService.getTodayLogEntries(),{totals:n,progress:o}=((e,t)=>{const a={calories:0,protein:0,carbs:0,fats:0,budget:0};t.forEach(e=>{a.calories+=e.totalCalories,a.protein+=e.totalProtein,a.carbs+=e.totalCarbs,a.fats+=e.totalFats,a.budget+=e.price});const n={calories:Math.min(100,a.calories/e.calories*100),protein:Math.min(100,a.protein/e.protein*100),carbs:Math.min(100,a.carbs/e.carbs*100),fats:Math.min(100,a.fats/e.fats*100)};return{totals:a,progress:n}})(t,a);var r;document.getElementById("home-content-area").innerHTML=`\n            <div class="budget">\n                Today's Budget: $${n.budget.toFixed(2)}\n            </div>\n\n            <div class="card macro-grid">\n                <div class="macro-item">\n                    <label>Calories</label>\n                    <div class="progress-bar-container">\n                        <div class="progress-bar calories" style="width: ${o.calories}%;"></div>\n                    </div>\n                    <div class="macro-values">${n.calories} / ${t.calories} kcal</div>\n                </div>\n\n                <div class="macro-item">\n                    <label>Protein</label>\n                    <div class="progress-bar-container">\n                        <div class="progress-bar protein" style="width: ${o.protein}%;"></div>\n                    </div>\n                    <div class="macro-values">${n.protein.toFixed(1)} / ${t.protein} g</div>\n                </div>\n\n                <div class="macro-item">\n                    <label>Carbs</label>\n                    <div class="progress-bar-container">\n                        <div class="progress-bar" style="background-color: #f39c12; width: ${o.carbs}%;"></div>\n                    </div>\n                    <div class="macro-values">${n.carbs.toFixed(1)} / ${t.carbs} g</div>\n                </div>\n\n                <div class="macro-item">\n                    <label>Fats</label>\n                    <div class="progress-bar-container">\n                        <div class="progress-bar" style="background-color: #e67e22; width: ${o.fats}%;"></div>\n                    </div>\n                    <div class="macro-values">${n.fats.toFixed(1)} / ${t.fats} g</div>\n                </div>\n            </div>\n\n            <div class="action-buttons">\n                <button id="btn-log-food" class="btn btn-log-food">\n                    <i class="fas fa-plus-circle"></i> &nbsp; LOG FOOD\n                </button>\n                <button id="btn-set-prices" class="btn btn-set-prices">\n                    <i class="fas fa-dollar-sign"></i> &nbsp; SET PRICES\n                </button>\n            </div>\n\n            <div class="card" style="margin-top: 20px; padding: 0 15px 15px 15px;">\n                <h3 style="margin: 15px 0 0 0;">Today's Logged Foods</h3>\n                ${r=a,0===r.length?'\n                <div style="text-align: center; color: var(--color-text-secondary); padding: 20px;">\n                    <i class="fas fa-file-alt fa-3x" style="margin-bottom: 10px;"></i>\n                    <p>Your food diary is empty</p>\n                    <p style="font-size: 0.8rem;">Tap "LOG FOOD" above to add your first meal!</p>\n                </div>\n            ':r.map(e=>`\n            <div class="logged-food-wrapper" data-entry-id="${e.id}">\n                <div class="swipe-content" id="swipe-content-${e.id}">\n                    <div class="food-details">\n                        <div class="food-name">${e.foodName}</div>\n                        <div class="food-macros">\n                            ${e.totalCalories} kcal (${e.amount}g) | $${e.price.toFixed(2)}\n                        </div>\n                    </div>\n                    <i class="fas fa-chevron-right" style="color: var(--color-border); padding-right: 15px;"></i>\n                </div>\n\n                <div class="swipe-actions">\n                    <button class="action-btn btn-edit" data-action="edit" data-id="${e.id}">\n                        <i class="fas fa-pen"></i> Edit\n                    </button>\n                    <button class="action-btn btn-delete" data-action="delete" data-id="${e.id}">\n                        <i class="fas fa-trash"></i> Delete\n                    </button>\n                </div>\n            </div>\n        `).join("")}\n            </div>\n\n            <button id="btn-food-history" class="btn btn-food-history">\n                <i class="fas fa-history"></i> &nbsp; FOOD HISTORY\n            </button>\n        `,e(),document.getElementById("btn-log-food").addEventListener("click",e=>{e.preventDefault(),renderView("logFood")}),document.getElementById("btn-set-prices").addEventListener("click",e=>{e.preventDefault(),renderView("setPrices")}),document.getElementById("btn-food-history").addEventListener("click",e=>{e.preventDefault(),renderView("foodHistory")})};return{render:()=>'\n            <div class="summary-header">\n                <h2>Nutrient Summary</h2>\n                <i id="btn-set-goals" class="fas fa-cog fa-lg" style="color: var(--color-text-secondary); cursor: pointer;"></i>\n            </div>\n            <div id="home-content-area">\n                <div class="budget">Loading Budget...</div>\n                <div class="card macro-grid">Loading goals and logs...</div>\n                <div class="action-buttons">\n                    <button id="btn-log-food" class="btn btn-log-food">\n                        <i class="fas fa-plus-circle"></i> &nbsp; LOG FOOD\n                    </button>\n                    <button id="btn-set-prices" class="btn btn-set-prices">\n                        <i class="fas fa-dollar-sign"></i> &nbsp; SET PRICES\n                    </button>\n                </div>\n                <div class="card" style="margin-top: 20px; padding: 0 15px 15px 15px;">\n                    <h3 style="margin: 15px 0 0 0;">Today\'s Logged Foods</h3>\n                    <div style="text-align: center; color: var(--color-text-secondary); padding: 20px;">\n                        Loading log entries...\n                    </div>\n                </div>\n                <button id="btn-food-history" class="btn btn-food-history">\n                    <i class="fas fa-history"></i> &nbsp; FOOD HISTORY\n                </button>\n            </div>\n        ',initEvents:()=>{t(),document.getElementById("btn-set-goals").addEventListener("click",e=>{e.preventDefault(),renderView("setGoals")})}}})(),LogDetailView=(()=>{let e=null,t=null,a=[];const n=()=>{const e=document.getElementById("saved-price-dropdown"),t=document.getElementById("log-amount"),n=document.getElementById("calculated-price"),o=parseFloat(t.value)||0,r=e.value;if(r&&o>0){const e=a.find(e=>e.id==r);if(e){const t=o*e.unitCost;return void(n.textContent=t.toFixed(2))}}n.textContent="0.00"},o=()=>{document.querySelectorAll('input[name="price-type"]').forEach(e=>{e.addEventListener("change",e=>{document.getElementById("manual-price-input").style.display="manual"===e.target.value?"block":"none",document.getElementById("store-price-selector").style.display="store"===e.target.value?"block":"none","store"===e.target.value&&n()})}),document.getElementById("saved-price-dropdown").addEventListener("change",n),document.getElementById("log-amount").addEventListener("input",n),document.querySelector('input[name="price-type"][value="store"]')&&document.querySelector('input[name="price-type"][value="store"]').checked&&n(),document.getElementById("btn-save-log-entry").addEventListener("click",n=>{n.preventDefault(),(async()=>{const n=parseFloat(document.getElementById("log-amount").value),o=document.querySelector('input[name="price-type"]:checked').value;let r=0;if(!n||n<=0)return void await showModal("Validation Error","Please enter a valid amount.");if("manual"===o)r=parseFloat(document.getElementById("log-price").value)||0;else if("store"===o){const e=document.getElementById("saved-price-dropdown").value;if(!e)return void await showModal("Selection Error","Please select a saved price record.");const t=a.find(t=>t.id==e);t&&(r=n*t.unitCost)}const i=e.unit.match(/^(\d+(\.\d+)?)/),s=n/(i?parseFloat(i[1]):100);let l={foodId:e.id,foodName:e.name,amount:n,totalCalories:Math.round(e.cal*s),totalProtein:Math.round(e.prot*s*10)/10,totalCarbs:Math.round(e.carb*s*10)/10,totalFats:Math.round(e.fat*s*10)/10,priceType:o,price:r};try{t?(l.id=t,await DataService.updateLogEntry(l)):await DataService.saveLogEntry(l),renderView("home")}catch(e){console.error("Error saving log entry:",e),await showModal("Database Error","Error saving log entry to database.")}})()})};return{render:e=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'logFood\'); return false;" class="header-action">\n                    CANCEL\n                </a>\n                <h2 class="view-title" id="log-detail-title">Loading...</h2>\n                <a href="#" id="btn-save-log-entry" class="header-action" style="display:none;">\n                    SAVE\n                </a>\n            </div>\n            <div id="log-detail-form-container" style="padding: 20px; text-align: center;">\n                 <p style="color: var(--color-text-secondary);">Fetching food details and prices...</p>\n            </div>\n        ',initEvents:n=>{(async n=>{let r,i=null,s="",l="",c=!0;if(n&&n.entryId){if(i=await DataService.getLogEntryById(n.entryId),!i)return;r=i.foodId,t=i.id,s=i.amount,l="manual"===i.priceType?i.price:"",c="manual"===i.priceType}else r=n,t=null;try{e=await FoodData.getFoodById(r),e||(await new Promise(e=>setTimeout(e,100)),e=await FoodData.getFoodById(r))}catch(t){console.error("Error fetching food item in LogDetailView:",t),e=null}if(!e)return void(document.getElementById("log-detail-form-container").innerHTML=`\n                <h1>Food Not Found</h1>\n                <p>Could not find food ID: ${r}. Please check browser console for IndexedDB errors.</p>\n            `);a=await DataService.getPricesByFoodId(r);const d=t?`Edit ${e.name}`:e.name;document.getElementById("log-detail-title").textContent=d,document.getElementById("btn-save-log-entry").style.display="block";const u=e.unit.includes("unit")?"Amount (units)":"Amount (g/ml)",p=a.length>0?a.map(e=>`<option value="${e.id}">${e.priceText} at ${e.storeName}</option>`).join(""):'<option value="">No Saved Prices</option>',m=`\n            <div class="log-form">\n                <div class="input-group">\n                    <label for="log-amount">${u}</label>\n                    <input type="number" id="log-amount" placeholder="Enter amount" value="${s}">\n                </div>\n\n                <div class="radio-group" style="margin-top: 30px;">\n                    <label class="radio-option">\n                        <input type="radio" name="price-type" value="manual" ${c?"checked":""}> Manual Price\n                    </label>\n                    <label class="radio-option">\n                        <input type="radio" name="price-type" value="store" ${c?"":"checked"} ${0===a.length?"disabled":""}> Store Price (${a.length} saved)\n                    </label>\n                </div>\n\n                <div id="manual-price-input" class="input-group" style="margin-top: 20px; display: ${c?"block":"none"};">\n                    <label for="log-price">Price ($)</label>\n                    <input type="number" id="log-price" placeholder="Enter total price (optional)" value="${l}">\n                </div>\n\n                <div id="store-price-selector" style="display: ${c?"none":"block"}; margin-top: 20px;">\n                    <div class="input-group">\n                        <label for="saved-price-dropdown">Select Saved Price</label>\n                        <select id="saved-price-dropdown">\n                            ${p}\n                        </select>\n                    </div>\n                    <div class="input-group">\n                         <label>Calculated Price ($)</label>\n                         <div id="calculated-price" style="font-size: 1.2rem;">0.00</div>\n                    </div>\n                </div>\n            </div>\n        `;document.getElementById("log-detail-form-container").innerHTML=m,o()})(n)}}})(),LogFoodView=(()=>{let e="",t="ALL";const a=e=>{const t=parseFloat(e.cal)||0,a=parseFloat(e.prot)||0,n=parseFloat(e.carb)||0,o=parseFloat(e.fat)||0,r="custom"===e.type,i=r?"logged-food-wrapper":"food-list-item",s=r?`data-custom-id="${e.id}"`:`data-food-id="${e.id}"`,l=r?'data-action="open"':'data-action="log"';let c=`\n            <div class="food-name">${e.name}</div>\n            <div class="food-macros">\n                ${t} kcal | P: ${a.toFixed(1)}g | C: ${n.toFixed(1)}g | F: ${o.toFixed(1)}g (per ${e.unit})\n            </div>\n        `;return r?`\n                <div class="${i}" ${s}>\n                    <div class="swipe-content" ${l}>\n                        ${c}\n                        <i class="fas fa-chevron-right" style="color: var(--color-border); padding-right: 15px;"></i>\n                    </div>\n\n                    <div class="swipe-actions">\n                        <button class="action-btn btn-delete" data-action="delete" data-id="${e.id}">\n                            <i class="fas fa-trash"></i> Delete\n                        </button>\n                    </div>\n                </div>\n            `:`\n                <div class="${i}" ${s} ${l}>\n                    ${c}\n                </div>\n            `},n=async()=>{const n=document.getElementById("food-list-container");n.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">Searching foods...</p>';try{const i=await FoodData.searchFoods(e,t);if(0===i.length)return void(n.innerHTML=`<div style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">\n                    <p>No foods found matching "${e}" filtered by ${t}.</p>\n                </div>`);n.innerHTML=i.map(a).join(""),o(),r()}catch(e){console.error("Error loading food list:",e),n.innerHTML='<p style="text-align: center; color: var(--color-red); padding: 50px 20px;">Failed to load food list.</p>'}},o=()=>{document.querySelectorAll('.food-list-item[data-action="log"]').forEach(e=>{e.addEventListener("click",()=>{if(window.wasSwiped)return void(window.wasSwiped=!1);const t=e.getAttribute("data-food-id");renderView("logDetail",t)})}),document.querySelectorAll('.action-btn[data-action="delete"]').forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();(async e=>{if(await showModal("Delete Custom Food?","Are you sure you want to permanently delete this custom food entry? This will not remove any existing log entries that used it.","confirm"))try{await FoodData.deleteCustomFood(e),n()}catch(e){console.error("Error deleting custom food:",e),await showModal("Deletion Error","Could not delete custom food from database.")}})(e.getAttribute("data-id"))})}),document.querySelectorAll('.swipe-content[data-action="open"]').forEach(e=>{e.addEventListener("click",()=>{if(window.wasSwiped)return void(window.wasSwiped=!1);const t=e.closest(".logged-food-wrapper").getAttribute("data-custom-id");renderView("logDetail",t)})})},r=()=>{document.querySelectorAll(".logged-food-wrapper").forEach(e=>{const t=e.querySelector(".swipe-content");let a=0,n=0,o=!1;const r=e=>{a=e,o=!1,document.querySelectorAll(".swipe-content").forEach(e=>e.style.transform="translateX(0px)")};t.addEventListener("mousedown",e=>r(e.clientX)),t.addEventListener("touchstart",e=>r(e.touches[0].clientX));const i=e=>{n=e-a,Math.abs(n)>5&&(o=!0),n<0?(n=Math.max(-70,n),t.style.transform=`translateX(${n}px)`):n>0&&(t.style.transform="translateX(0px)")};document.addEventListener("mousemove",e=>{0!==a&&i(e.clientX)}),document.addEventListener("touchmove",e=>{0!==a&&i(e.touches[0].clientX)});const s=()=>{0!==a&&(n<-35?(t.style.transform="translateX(-70px)",window.wasSwiped=!0,setTimeout(()=>{window.wasSwiped=!1},300)):t.style.transform="translateX(0px)",a=0,n=0)};document.addEventListener("mouseup",s),document.addEventListener("touchend",s)})};return{render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'home\'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title" style="margin-left: 15px;">Log Food</h2>\n                <a href="#" id="btn-add-custom-food" class="header-action">\n                    <i class="fas fa-plus-circle fa-lg" style="color: var(--color-primary-green);"></i>\n                </a>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <div class="search-bar-container">\n                    <i class="fas fa-search" style="color: var(--color-text-secondary);"></i>\n                    <input type="text" id="food-search-input" placeholder="Search static or custom foods...">\n                </div>\n            </div>\n\n            <div class="category-tabs" style="justify-content: space-evenly; padding: 0 0 10px 0; margin-bottom: 0;">\n                <button class="tab-button active" data-filter="ALL">ALL</button>\n                <button class="tab-button" data-filter="CAL">CALORIES</button>\n                <button class="tab-button" data-filter="PROTEIN">PROTEIN</button>\n                <button class="tab-button" data-filter="CARBS">CARBS</button>\n                <button class="tab-button" data-filter="FATS">FATS</button>\n            </div>\n\n            <div id="food-list-container" class="food-list-container">\n                <p style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">Loading food database...</p>\n            </div>\n            <div style="height: 60px;"></div>\n        ',initEvents:()=>{n(),document.getElementById("food-search-input").addEventListener("input",t=>{e=t.target.value,n()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active","protein","carbs","fats"));const a=e.target.getAttribute("data-filter");t=a,e.target.classList.add("active",a.toLowerCase()),n()})}),document.getElementById("btn-add-custom-food").addEventListener("click",e=>{e.preventDefault(),renderView("addCustomFood")})}}})(),ManageWorkoutsView=(()=>{let e=[];const t=async()=>{const t=document.getElementById("workout-list-container");t&&(t.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">Loading workouts...</p>');try{e=await DataService.getWorkouts()}catch(t){console.error("Failed to load workouts:",t),e=[],await showModal("Error","Failed to load saved workouts from the database.","alert")}var n;t&&(t.innerHTML=0===(n=e).length?'\n                <div style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">\n                    <i class="fas fa-list-alt fa-3x" style="margin-bottom: 15px;"></i>\n                    <p>No saved workouts found.</p>\n                    <p style="font-size: 0.9rem;">Start a Quick Workout or Create a new one using the \'+\' button to begin managing them here.</p>\n                </div>\n            ':n.map(e=>{const t=e.exercises&&e.exercises.length||0,a=e.id;return`\n            <div class="workout-list-item" data-id="${a}" data-is-expanded="false" style="border-bottom: 1px solid var(--color-border);">\n\n                <div class="workout-header-toggle" data-target="#workout-content-${a}" data-id="${a}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer;">\n                    <div style="flex-grow: 1;">\n                        <div id="workout-name-${a}" style="font-weight: bold;">${e.name}</div>\n                        <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${t} exercises</div>\n                    </div>\n                    <i id="chevron-${a}" class="fas fa-chevron-down fa-sm" style="color: var(--color-text-secondary); transition: transform 0.3s;"></i>\n                </div>\n\n                <div id="workout-content-${a}" class="collapsible-content" style="display: none; padding: 0 15px 15px;">\n\n                    <div class="workout-actions" style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px;">\n                        <button class="btn btn-start" data-id="${a}" style="flex: 1; background-color: var(--color-primary-blue); color: var(--color-text); padding: 10px;">\n                            <i class="fas fa-play"></i> START\n                        </button>\n                        <button class="btn btn-edit" data-id="${a}" style="flex: 1; background: none; border: 1px solid var(--color-text); color: var(--color-text); padding: 10px;">\n                            <i class="fas fa-edit"></i> EDIT\n                        </button>\n                    </div>\n\n                    <div style="display: flex; justify-content: center; gap: 20px;">\n                        <button class="btn btn-rename" data-id="${a}" data-name="${e.name}" style="background: none; border: none; color: var(--color-primary-blue); font-weight: bold; padding: 5px;">\n                            RENAME\n                        </button>\n                        <button class="btn btn-delete" data-id="${a}" style="background: none; border: none; color: var(--color-red); font-weight: bold; padding: 5px;">\n                            DELETE\n                        </button>\n                    </div>\n\n                    </div>\n            </div>\n        `}).join(""),a())},a=()=>{document.querySelectorAll(".workout-header-toggle").forEach(e=>{e.addEventListener("click",t=>{(e=>{const t=document.getElementById(`workout-content-${e}`),a=document.getElementById(`chevron-${e}`),n="block"===t.style.display;document.querySelectorAll(".workout-list-item").forEach(t=>{const a=t.getAttribute("data-id"),n=document.getElementById(`workout-content-${a}`),o=document.getElementById(`chevron-${a}`);a!=e&&(n.style.display="none",o&&(o.style.transform="rotate(0deg)"),t.setAttribute("data-is-expanded","false"))}),n?(t.style.display="none",a.style.transform="rotate(0deg)",document.querySelector(`.workout-list-item[data-id="${e}"]`).setAttribute("data-is-expanded","false")):(t.style.display="block",a.style.transform="rotate(180deg)",document.querySelector(`.workout-list-item[data-id="${e}"]`).setAttribute("data-is-expanded","true"))})(e.getAttribute("data-id"))})}),document.querySelectorAll(".btn-rename").forEach(e=>{e.addEventListener("click",()=>{(async(e,t)=>{if(await showModal("Rename Workout",`\n            Enter a new name for "${t}":\n            <input type="text" id="rename-input" class="input-group" value="${t}"\n                style="width: 95%; margin-top: 10px; padding: 8px; border: 1px solid var(--color-border); background-color: var(--color-background); color: var(--color-text);">\n          `,"confirm")){const a=document.getElementById("rename-input"),n=a?a.value.trim():"";if(!n||n===t)return void await showModal("Validation","Name cannot be empty or the same as the old name.","alert");try{await DataService.updateWorkoutName(parseInt(e,10),n),document.getElementById(`workout-name-${e}`).textContent=n,document.querySelector(`.btn-rename[data-id="${e}"]`).setAttribute("data-name",n),await showModal("Success",`Workout renamed to "${n}".`,"alert")}catch(e){console.error("Error renaming workout:",e),await showModal("Error","Failed to rename workout.","alert")}}})(e.dataset.id,e.dataset.name)})}),document.querySelectorAll(".btn-delete").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.id;(async(e,a)=>{if(await showModal("Delete Workout",`Are you sure you want to permanently delete the workout: "${a}"? This cannot be undone.`,"confirm"))try{await DataService.deleteWorkout(e),await showModal("Success",`Workout "${a}" deleted.`,"alert"),t()}catch(e){console.error("Error deleting workout:",e),await showModal("Error","Failed to delete workout.","alert")}})(a,document.getElementById(`workout-name-${a}`).textContent)})}),document.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;renderView("editWorkoutDetail",t)})}),document.querySelectorAll(".btn-start").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;renderView("workoutSession",parseInt(t,10))})})},n=async()=>{const e=document.getElementById("new-workout-name"),a=e.value.trim();if(a)try{await DataService.saveWorkout(a);e.value="",t()}catch(e){console.error("Error creating workout:",e),await showModal("Error","Could not save the workout to the database.","alert")}else await showModal("Validation","Please enter a name for the new workout.","alert")};return{render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'workout\'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title" style="margin-left: 15px;">Manage Workouts</h2>\n                <div></div>\n            </div>\n\n            <div style="padding: 15px;">\n                <div id="new-workout-input" class="input-group" style="display: flex; align-items: center; border-bottom: none; padding-bottom: 0;">\n                    <input type="text" id="new-workout-name" placeholder="e.g., Push Day A" style="flex-grow: 1; font-size: 1rem; border-bottom: 1px solid var(--color-border); padding-bottom: 5px;"/>\n                    <button id="btn-create-workout" class="btn" style="width: 50px; height: 35px; font-size: 0.9rem; margin-left: 10px; background-color: var(--color-primary-green); color: var(--color-text);">\n                        <i class="fas fa-plus"></i>\n                    </button>\n                </div>\n            </div>\n\n            <h3 style="padding: 0 15px; margin: 0 0 10px; color: var(--color-text-secondary);">My Workouts</h3>\n\n            <div id="workout-list-container" class="card" style="margin: 0 15px; padding: 0;">\n                </div>\n        ',initEvents:()=>{t(),document.getElementById("btn-create-workout").addEventListener("click",n)}}})(),MetricsView=(()=>{let e="ALL",t=0,a=(new Date).setFullYear((new Date).getFullYear()+100);const n=e=>new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),o=e=>{const t=new Date(e);return`${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}/${t.getFullYear()}`},r=e=>{const t=e.split("/");if(3!==t.length)return null;const a=new Date(`${t[2]}/${t[0]}/${t[1]}`);return isNaN(a)||a.getFullYear()!==parseInt(t[2],10)?null:a},i=()=>{document.querySelectorAll(".logged-food-wrapper").forEach(e=>{const t=e.querySelector(".swipe-content");let a=0,n=0;const o=e=>{a=e,document.querySelectorAll(".swipe-content").forEach(e=>e.style.transform="translateX(0px)")};t.addEventListener("mousedown",e=>o(e.clientX)),t.addEventListener("touchstart",e=>o(e.touches[0].clientX));const r=e=>{n=e-a,n<0?(n=Math.max(-70,n),t.style.transform=`translateX(${n}px)`):n>0&&(t.style.transform="translateX(0px)")};document.addEventListener("mousemove",e=>{0!==a&&r(e.clientX)}),document.addEventListener("touchmove",e=>{0!==a&&r(e.touches[0].clientX)});const i=()=>{0!==a&&(n<-35?(t.style.transform="translateX(-70px)",window.wasSwiped=!0):t.style.transform="translateX(0px)",a=0,n=0,window.wasSwiped&&setTimeout(()=>{window.wasSwiped=!1},300))};document.addEventListener("mouseup",i),document.addEventListener("touchend",i)})},s=async()=>{const n=document.getElementById("weight-input"),o=parseFloat(n.value);if(isNaN(o)||o<=0)await showModal("Input Error","Please enter a valid positive weight.","alert");else try{await DataService.logWeightEntry(o),n.value="",await showModal("Success","Weight logged successfully!","alert"),l(e,t,a)}catch(e){console.error("Error logging weight:",e),await showModal("Error","Failed to save weight data.","alert")}},l=async(n,r=null,s=null)=>{e=n;const l=document.getElementById("weight-history-list"),u=document.getElementById("latest-weight-card");if(document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),"CUSTOM"!==n){const e=document.getElementById(`filter-range-${n.toLowerCase()}`);e&&e.classList.add("active")}let p,y;if("CUSTOM"===n&&r&&s)p=r,y=s;else if("ALL"===n)p=0,y=(new Date).getTime();else{const e=DataService.getRangeDates(n);p=e.start,y=e.end}t=p,a=y;const b='<i class="fas fa-calendar-alt"></i>',f=document.getElementById("btn-select-custom-range");f&&("CUSTOM"===n?(f.innerHTML=`${b} &nbsp; ${o(t)} - ${o(a)}`,f.style.border="1px solid var(--color-primary-blue)"):(f.innerHTML=`${b} &nbsp; Select Custom Range`,f.style.border="none")),l&&(l.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 30px;">Loading history...</p>');try{const e=await DataService.getLatestWeight(),n=await DataService.getWeightHistoryByRange(t,a);u&&(u.innerHTML=c(e),m()),l&&(l.innerHTML=d(n),g(),i())}catch(e){console.error("Failed to load metrics data:",e),l&&(l.innerHTML='<p style="text-align: center; color: var(--color-red); padding: 30px;">ERROR: Failed to load data. Please ensure DataService has the correct methods.</p>')}},c=e=>{const t=e&&e.weight?`${e.weight} kg`:"N/A";return`\n        <div style="padding: 15px;">\n            <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.85rem;">Logged on: ${e&&e.timestamp?n(e.timestamp):n(Date.now())}</p>\n            <h1 style="margin: 5px 0 10px 0; font-size: 2.5rem; font-weight: bold;">${t}</h1>\n            <p style="margin: 0 0 15px 0; color: #aaa; font-size: 0.9rem;">CURRENT WEIGHT</p>\n\n            <div class="input-group" style="padding-bottom: 5px; margin-bottom: 20px;">\n                <label style="color: var(--color-text-secondary); font-size: 0.8rem;">Log New Weight (kg)</label>\n                <input type="number" id="weight-input" placeholder="Enter weight" style="font-size: 1.2rem;">\n            </div>\n\n            <button id="btn-log-weight" class="btn" style="background-color: var(--color-primary-blue); color: var(--color-text); padding: 15px; width: 100%; border-radius: 8px;">\n                <i class="fas fa-plus-circle"></i> &nbsp; Log Weight\n            </button>\n        </div>\n    `},d=e=>0===e.length?'<p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">No weight entries in this range.</p>':e.map(e=>`\n        <div class="logged-food-wrapper" data-id="${e.id}">\n            <div class="swipe-content" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; min-height: 50px;">\n                <div>\n                    <div style="font-weight: bold; font-size: 1.1rem;">${e.weight} kg</div>\n                    <div style="color: var(--color-text-secondary); font-size: 0.85rem;">${n(e.timestamp)}</div>\n                </div>\n                <i class="fas fa-chevron-right" style="color: var(--color-border); padding-right: 5px;"></i>\n            </div>\n            <div class="swipe-actions">\n                <button class="action-btn btn-delete delete-weight-entry" data-id="${e.id}">\n                    <i class="fas fa-trash"></i> Delete\n                </button>\n            </div>\n        </div>\n    `).join(""),u=()=>{window.showModal("Select Custom Date Range",`\n      <div style="padding: 20px;">\n        <p style="margin-top: 0; color: var(--color-text-secondary);">\n          Select the date range for filtering the weight history.\n        </p>\n        <div class="input-group">\n          <label for="modal-start-date-input">Start Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-start-date-input" placeholder="MM/DD/YYYY" value="${o(t||Date.now())}">\n        </div>\n        <div class="input-group">\n          <label for="modal-end-date-input">End Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-end-date-input" placeholder="MM/DD/YYYY" value="${o(a||Date.now())}">\n        </div>\n      </div>\n    `,"confirm").then(async e=>{if(e){const e=document.getElementById("modal-start-date-input").value,t=document.getElementById("modal-end-date-input").value,a=r(e),n=r(t);if(!a||!n||a.getTime()>n.getTime())return await showModal("Error","Invalid dates. Please try again.","alert"),void u();n.setHours(23,59,59,999),l("CUSTOM",a.getTime(),n.getTime())}})},p=async()=>{const e=await DataService.getWeightHistoryByRange(t,a);if(0===e.length)return void await showModal("No Data","No history to export in this range.","alert");let o="Date,Weight (kg)\n";e.forEach(e=>{const t=n(e.timestamp);o+=`"${t}",${e.weight}\n`});const r=new Blob([o],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download=`WeightHistory_Export_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),await showModal("Export Complete","Weight history exported successfully.","alert")},m=()=>{document.getElementById("btn-log-weight").addEventListener("click",s)},g=()=>{document.querySelectorAll(".delete-weight-entry").forEach(n=>{n.addEventListener("click",o=>{o.stopPropagation();(async n=>{if(await showModal("Delete Entry","Remove this weight entry?","confirm"))try{await DataService.deleteWeightEntry(parseInt(n,10)),l(e,t,a)}catch(e){console.error("Deletion failed:",e),await showModal("Error","Failed to delete entry.","alert")}})(n.dataset.id)})}),i()};return{render:()=>`\n            <div class="view-header">\n                <h2 class="view-title" style="margin-left: 15px;">Metrics</h2>\n                <div>\n                    <i id="btn-export-metrics" class="fas fa-cloud-download-alt fa-lg" style="color: var(--color-text); cursor: pointer; margin-right: 15px;"></i>\n                    <i id="btn-import-metrics" class="fas fa-cloud-upload-alt fa-lg" style="color: var(--color-text); cursor: pointer;"></i>\n                </div>\n            </div>\n\n            <div id="latest-weight-card" class="card" style="margin: 15px;">\n                ${c({weight:"...",timestamp:Date.now()})}\n            </div>\n\n            <h3 style="margin: 0 15px 15px 15px; font-weight: bold;">Weight History</h3>\n\n            <div class="category-tabs" style="padding: 0 0 10px 0;">\n                <button id="filter-range-all" class="tab-button active">ALL</button>\n                <button id="filter-range-week" class="tab-button">WEEK</button>\n                <button id="filter-range-month" class="tab-button">MONTH</button>\n                <button id="filter-range-year" class="tab-button">YEAR</button>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <button id="btn-select-custom-range" class="btn" style="background-color: var(--color-card); color: var(--color-text); margin-bottom: 20px; justify-content: flex-start; border: 1px solid transparent;">\n                    <i class="fas fa-calendar-alt"></i> &nbsp; Select Custom Range\n                </button>\n            </div>\n\n            <div id="weight-history-list" style="padding: 0 15px;">\n                </div>\n        `,initEvents:()=>{l("ALL"),document.getElementById("filter-range-all").addEventListener("click",()=>l("ALL")),document.getElementById("filter-range-week").addEventListener("click",()=>l("WEEK")),document.getElementById("filter-range-month").addEventListener("click",()=>l("MONTH")),document.getElementById("filter-range-year").addEventListener("click",()=>l("YEAR")),document.getElementById("btn-select-custom-range").addEventListener("click",u),document.getElementById("btn-export-metrics").addEventListener("click",p)}}})(),SelectExerciseView=(()=>{let e=null,t="",a="All Muscles",n="All",o=[];const r=(e,t,a)=>`\n          <select id="${e}"\n                  style="font-size: 1.1rem;\n                         padding: 10px;\n                         width: 100%;\n                         margin-top: 5px;\n                         background-color: var(--color-card);\n                         color: var(--color-text);\n                         border: 1px solid var(--color-border);\n                         border-radius: 8px;">\n              ${t.map(e=>`<option value="${e}" ${e===a?"selected":""}>${e}</option>`).join("")}\n          </select>\n      `,i=async()=>{const e=await ExerciseData.searchExercises(t,a,n);var r;o=e,document.getElementById("exercise-results-container").innerHTML=0===(r=e).length?'\n                <div style="text-align: center; padding: 30px 20px;">\n                    <p style="color: var(--color-text-secondary);">No exercises found matching your search and filters.</p>\n                </div>\n            ':r.map(e=>{const t="custom"===e.type,a=`\n            <div class="exercise-details" style="cursor: pointer; flex-grow: 1;" data-action="select" data-id="${e.id}">\n                <div style="font-weight: bold;">${e.name} ${t?"(Custom)":""}</div>\n                <div style="font-size: 0.8rem; color: var(--color-text-secondary);">\n                    ${e.muscle||"uncategorized"} | ${e.equipment||"other"}\n                </div>\n            </div>\n        `;return t?`\n            <div class="logged-food-wrapper" data-id="${e.id}">\n                <div class="swipe-content" data-id="${e.id}" data-action="select">\n                    ${a}\n                    <i class="fas fa-chevron-right" style="color: var(--color-border); padding-right: 15px;"></i>\n                </div>\n                <div class="swipe-actions">\n                    <button class="action-btn btn-delete" data-action="delete" data-id="${e.id}">\n                        <i class="fas fa-trash"></i> Delete\n                    </button>\n                </div>\n            </div>\n          `:`\n            <div class="food-list-item" data-id="${e.id}" data-type="${e.type}">\n                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">\n                    ${a}\n                    <i class="fas fa-chevron-right" style="color: var(--color-primary-green); margin-left: 15px;"></i>\n                </div>\n            </div>\n          `}).join(""),s(),c(),document.querySelectorAll(".logged-food-wrapper").forEach(e=>{const t=e.querySelector(".swipe-content");let a=0,n=0;const o=e=>{a=e,document.querySelectorAll(".swipe-content").forEach(e=>e.style.transform="translateX(0px)")};t.addEventListener("mousedown",e=>o(e.clientX)),t.addEventListener("touchstart",e=>o(e.touches[0].clientX));const r=e=>{n=e-a,n<0?(n=Math.max(-70,n),t.style.transform=`translateX(${n}px)`):n>0&&(t.style.transform="translateX(0px)")};document.addEventListener("mousemove",e=>{0!==a&&r(e.clientX)}),document.addEventListener("touchmove",e=>{0!==a&&r(e.touches[0].clientX)});const i=()=>{0!==a&&(n<-35?(t.style.transform="translateX(-70px)",window.wasSwiped=!0):t.style.transform="translateX(0px)",a=0,n=0,window.wasSwiped&&setTimeout(()=>{window.wasSwiped=!1},300))};document.addEventListener("mouseup",i),document.addEventListener("touchend",i)})},s=()=>{document.querySelectorAll(".food-list-item .exercise-details").forEach(e=>{e.addEventListener("click",l)}),document.querySelectorAll('.swipe-content[data-action="select"]').forEach(e=>{e.addEventListener("click",l)})},l=async t=>{if(t.target.closest(".logged-food-wrapper")&&window.wasSwiped)return void(window.wasSwiped=!1);const a=t.currentTarget.dataset.id,n=o.find(e=>e.id===a);if(n)try{await DataService.addExerciseToWorkout(e,n),await showModal("Success",`Exercise "${n.name}" added to workout!`,"alert"),renderView("editWorkoutDetail",e)}catch(t){console.error("Error adding exercise to workout:",t),await showModal("Error",`Failed to add exercise: ${t.message||t}.`,"alert")}else await showModal("Error","Selected exercise data not found.","alert")},c=()=>{document.querySelectorAll(".action-btn.btn-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),(async e=>{if(await showModal("Delete Custom Exercise?","Are you sure you want to permanently delete this custom exercise? It will be removed from all workouts, but existing workout history logs will remain.","confirm"))try{await DataService.deleteCustomExercise(e),await showModal("Success","Custom exercise deleted.","alert"),i()}catch(e){console.error("Error deleting custom exercise:",e),await showModal("Error","Failed to delete custom exercise.","alert")}})(e.dataset.id)})})},d=()=>{const e=["All Muscles",...ExerciseData.MUSCLE_GROUPS.filter(e=>"All Muscles"!==e)],o=["All",...ExerciseData.EQUIPMENT_TYPES];document.getElementById("muscle-group-container").innerHTML=r("muscle-group-select",e,a),document.getElementById("equipment-filter-container").innerHTML=r("equipment-select",o,n),document.getElementById("search-input").addEventListener("input",e=>{t=e.target.value.trim(),i()}),document.getElementById("muscle-group-select").addEventListener("change",e=>{a=e.target.value,i()}),document.getElementById("equipment-select").addEventListener("change",e=>{n=e.target.value,i()}),i()},u=()=>{renderView("createNewExercise",{workoutId:e,name:t})};return{render:a=>(e=a,`\n            <div class="view-header" style="border-bottom: 1px solid var(--color-border);">\n                <a href="#" onclick="renderView('editWorkoutDetail', ${e}); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title">Add Exercise</h2>\n                <a href="#" id="btn-add-custom-exercise" class="header-action">\n                    <i class="fas fa-plus-circle fa-lg" style="color: var(--color-primary-green);"></i>\n                </a>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <div class="search-bar-container" style="margin-top: 15px; margin-bottom: 0;">\n                    <i class="fas fa-search" style="color: var(--color-text-secondary);"></i>\n                    <input type="text" id="search-input" placeholder="Search for an exercise..." value="${t}">\n                </div>\n            </div>\n\n            <div style="padding: 15px;">\n                <h3 style="margin-top: 0; margin-bottom: 5px;">Muscle Group</h3>\n                <div id="muscle-group-container" style="margin-bottom: 15px;">\n                    </div>\n\n                <h3 style="margin-bottom: 5px;">Equipment</h3>\n                <div id="equipment-filter-container" style="margin-bottom: 20px;">\n                    </div>\n            </div>\n\n            <div id="exercise-results-container" class="food-list-container">\n                </div>\n        `),initEvents:t=>{e=t,d(),document.getElementById("btn-add-custom-exercise").addEventListener("click",u)}}})(),SelectFoodForPriceView=(()=>{let e="";const t=async()=>{try{const n=await FoodData.searchFoods(e,"ALL"),o=document.getElementById("food-select-container");o&&(o.innerHTML=0===(t=n).length?'<div style="text-align: center; color: var(--color-text-secondary); padding: 20px;">\n                        <p>No foods found matching your search.</p>\n                    </div>':t.map(e=>`\n            <div class="food-list-item select-food-btn" data-food-id="${e.id}">\n                <div class="food-name">${e.name}</div>\n                <div class="food-macros">\n                    ${e.cal} kcal | P: ${e.prot}g | C: ${e.carb}g | F: ${e.fat}g (per ${e.unit})\n                </div>\n            </div>\n        `).join(""),a())}catch(e){console.error("Error loading foods for price selection:",e),document.getElementById("food-select-container").innerHTML='<p style="text-align: center; color: var(--color-red); padding: 20px;">Failed to load foods.</p>'}var t},a=()=>{document.querySelectorAll(".select-food-btn").forEach(e=>{e.addEventListener("click",async()=>{const t=e.getAttribute("data-food-id"),a=await FoodData.getFoodById(t);SetPricesView.setSelectedFood(a),renderView("setPrices")})})};return{render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'setPrices\'); return false;" class="header-action">\n                    CLOSE\n                </a>\n                <h2 class="view-title">Select Food</h2>\n                <div></div>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <div class="search-bar-container">\n                    <i class="fas fa-search" style="color: var(--color-text-secondary);"></i>\n                    <input type="text" id="food-search-input" placeholder="Search foods...">\n                </div>\n            </div>\n\n            <div id="food-select-container" class="food-list-container">\n                <p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">Loading food list...</p>\n            </div>\n        ',initEvents:()=>{t(),document.getElementById("food-search-input").addEventListener("input",a=>{e=a.target.value,t()})}}})(),SetPricesView=(()=>{let e=null,t=null;const a=async()=>{try{const e=await DataService.exportAllData(),t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download="nutrition_budget_backup.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),await showModal("Export Successful","Data exported successfully! It should start downloading now.")}catch(e){console.error("Export Error:",e),await showModal("Export Failed","Export failed. Check console for details.")}},n=e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=async e=>{try{const t=JSON.parse(e.target.result),a=await DataService.importData(t);a>0?await showModal("Import Successful",`Import successful! ${a} data categories updated. The app will reload the home view.`):await showModal("Import Failed","Import failed: Data structure invalid or no recognized keys found."),renderView("home")}catch(e){await showModal("Import Failed","Import failed: File is not a valid JSON format or DB error occurred."),console.error("Import Error:",e)}},a.readAsText(t)},o=async()=>{const a=document.getElementById("selected-store-name"),n=document.getElementById("selected-food-name");a.textContent=e?e.name:"Select Store",n.textContent=t?t.name:"Select Food",document.getElementById("saved-prices-list").innerHTML='<p style="text-align: center;">Loading prices...</p>',document.getElementById("saved-prices-list").innerHTML=await(async()=>{try{const[e,t]=await Promise.all([DataService.getPriceRecords(),DataService.getStores()]);if(0===e.length)return'<div class="food-list-item" style="text-align: center; color: var(--color-text-secondary);">No Saved Prices.</div>';const a=await FoodData.getAllFoods();return e.map(e=>{const n=a.find(t=>t.id===e.foodId),o=t.find(t=>t.id===e.storeId),r=o?o.name:"Unknown Store",i=n?n.name:"Unknown Food",s=`$${e.price.toFixed(2)} / ${e.amount}${e.unit}`;return`\n            <div class="logged-food-wrapper" data-id="${e.id}">\n                <div class="swipe-content" data-id="${e.id}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;">\n                    <div>\n                        <div class="food-name">${i}</div>\n                        <div class="food-macros">${r} - ${s}</div>\n                    </div>\n                </div>\n                <div class="swipe-actions">\n                    <button class="action-btn btn-delete" data-action="delete" data-id="${e.id}">\n                        <i class="fas fa-trash"></i> Delete\n                    </button>\n                </div>\n            </div>\n          `}).join("")}catch(e){return console.error("Error rendering saved prices:",e),'<div class="food-list-item" style="text-align: center; color: var(--color-red);">Failed to load price records.</div>'}})(),i(),document.querySelectorAll(".logged-food-wrapper").forEach(e=>{const t=e.querySelector(".swipe-content");let a=0,n=0;const o=e=>{a=e,document.querySelectorAll(".swipe-content").forEach(e=>e.style.transform="translateX(0px)")};t.addEventListener("mousedown",e=>o(e.clientX)),t.addEventListener("touchstart",e=>o(e.touches[0].clientX));const r=e=>{n=e-a,n<0?(n=Math.max(-70,n),t.style.transform=`translateX(${n}px)`):n>0&&(t.style.transform="translateX(0px)")};document.addEventListener("mousemove",e=>{0!==a&&r(e.clientX)}),document.addEventListener("touchmove",e=>{0!==a&&r(e.touches[0].clientX)});const i=()=>{0!==a&&(n<-35?(t.style.transform="translateX(-70px)",window.wasSwiped=!0):t.style.transform="translateX(0px)",a=0,n=0,window.wasSwiped&&setTimeout(()=>{window.wasSwiped=!1},300))};document.addEventListener("mouseup",i),document.addEventListener("touchend",i)})},r=async()=>{if(!e||!t)return void await showModal("Selection Error","Please select both a Store and a Food.");const a=parseFloat(document.getElementById("input-price").value),n=parseFloat(document.getElementById("input-amount").value);if(isNaN(a)||a<=0||isNaN(n)||n<=0)return void await showModal("Validation Error","Please enter valid Price and Amount values.");const r={storeId:e.id,foodId:t.id,price:a,amount:n,unit:"g"};try{await DataService.savePriceRecord(r),document.getElementById("input-price").value="",document.getElementById("input-amount").value="",o()}catch(e){console.error("Error saving price record:",e),await showModal("Database Error","Could not save price record to database.")}},i=()=>{document.querySelectorAll('.action-btn[data-action="delete"]').forEach(e=>{e.addEventListener("click",async e=>{e.stopPropagation();(async e=>{if(await showModal("Delete Price Record","Are you sure you want to delete this price record?","confirm"))try{await DataService.deletePriceRecord(parseInt(e)),o()}catch(e){console.error("Error deleting price record:",e),await showModal("Delete Error","Could not delete price record.")}})(e.target.getAttribute("data-id"))})})},s=async()=>{if(await showModal("DANGER ZONE","DANGER: Reset ALL Price and Store data? This cannot be undone.","confirm"))try{await DataService.clearStore("priceStores"),await DataService.clearStore("priceRecords"),await showModal("Success","Price and Store data cleared."),o()}catch(e){console.error("Error resetting price data:",e),await showModal("Reset Error","Could not clear price data.")}},l=async()=>{if(await showModal("DANGER ZONE","DANGER: Reset ALL Custom Food data? This cannot be undone.","confirm"))try{await DataService.clearStore("customFoods"),await showModal("Success","Custom Food data cleared."),o()}catch(e){console.error("Error resetting custom food data:",e),await showModal("Reset Error","Could not clear custom food data.")}};return window.SetPricesView={setSelectedStore:t=>{e=t,o()},setSelectedFood:e=>{t=e,o()},render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'home\'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title">Set Prices</h2>\n                <div></div>\n            </div>\n\n            <div class="card">\n                <h3>Add New Price</h3>\n                <div class="input-group" id="btn-select-store">\n                    <label>Store</label>\n                    <div id="selected-store-name" style="font-size: 1.1rem; color: var(--color-text-secondary); cursor: pointer;">Select Store</div>\n                </div>\n                <div class="input-group" id="btn-select-food">\n                    <label>Food</label>\n                    <div id="selected-food-name" style="font-size: 1.1rem; color: var(--color-text-secondary); cursor: pointer;">Select Food</div>\n                </div>\n                <div class="input-group">\n                    <label for="input-price">Price ($)</label>\n                    <input type="number" id="input-price" placeholder="e.g., 10.99">\n                </div>\n                <div class="input-group">\n                    <label for="input-amount">Amount (g/unit)</label>\n                    <input type="number" id="input-amount" placeholder="e.g., 500">\n                </div>\n                <button id="btn-save-price" class="btn" style="background-color: var(--color-primary-blue); color: var(--color-text); margin-top: 15px;">SAVE PRICE</button>\n            </div>\n\n            <div class="card">\n                <h3>Saved Prices</h3>\n                <div id="saved-prices-list">\n                    <p style="text-align: center;">Loading saved prices...</p>\n                </div>\n            </div>\n\n            <div class="card import-export-section">\n                <h3>Import / Export Data</h3>\n\n                <label>Export/Import All Data</label>\n                <div class="button-group">\n                    <button id="btn-export-data" class="btn" style="background-color: var(--color-primary-blue);">EXPORT ALL DATA</button>\n                    <button id="btn-import-data" class="btn" style="background-color: var(--color-primary-blue);">IMPORT DATA FROM FILE</button>\n                </div>\n\n                <label>Danger Zone</label>\n                <div class="button-group">\n                    <button id="btn-reset-price-data" class="btn btn-danger">RESET ALL PRICE DATA</button>\n                    <button id="btn-reset-custom-food" class="btn btn-danger">RESET ALL CUSTOM FOODS</button>\n                </div>\n            </div>\n        ',initEvents:()=>{const e=(()=>{const e=document.createElement("input");return e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",n),document.body.appendChild(e),e})();o(),document.getElementById("btn-select-store").addEventListener("click",()=>{renderView("storeManager")}),document.getElementById("btn-select-food").addEventListener("click",()=>{renderView("selectFoodForPrice")}),document.getElementById("btn-save-price").addEventListener("click",r),document.getElementById("btn-export-data").addEventListener("click",a),document.getElementById("btn-import-data").addEventListener("click",()=>e.click()),document.getElementById("btn-reset-price-data").addEventListener("click",s),document.getElementById("btn-reset-custom-food").addEventListener("click",l)}},window.SetPricesView})(),StoreManagerView=(()=>{const e=async()=>{const e=document.getElementById("new-store-name"),t=e.value.trim();if(t)try{await DataService.saveStore(t),e.value="",a()}catch(e){console.error("Error saving store:",e),await showModal("Database Error","Could not save store to database.")}},t=()=>{document.getElementById("btn-add-store").addEventListener("click",e),document.querySelectorAll(".select-store-item").forEach(e=>{e.addEventListener("click",e=>{e.target.classList.contains("delete-store-btn")||(e=>{const t=e.target.closest(".select-store-item");if(!t)return;const a={id:parseInt(t.getAttribute("data-store-id")),name:t.getAttribute("data-store-name")};window.SetPricesView.setSelectedStore(a),renderView("setPrices")})(e)})}),document.querySelectorAll(".delete-store-btn").forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation(),(async e=>{if(await showModal("Warning","Warning: Deleting this store will also invalidate related price records. Proceed?","confirm"))try{await DataService.deleteStore(e),a()}catch(e){console.error("Error deleting store:",e),await showModal("Database Error","Could not delete store from database.")}})(parseInt(e.target.getAttribute("data-id")))})})},a=async()=>{document.getElementById("store-list-container").innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">Loading stores...</p>';try{const e=await DataService.getStores(),a=document.getElementById("store-list-container");a&&(a.innerHTML=(e=>0===e.length?'<div style="text-align: center; color: var(--color-text-secondary); padding: 20px;">No saved stores.</div>':e.map(e=>`\n            <div class="food-list-item select-store-item" data-store-id="${e.id}" data-store-name="${e.name}" style="display: flex; justify-content: space-between; align-items: center;">\n                ${e.name}\n                <i class="fas fa-trash fa-sm delete-store-btn" data-id="${e.id}" style="color: var(--color-red); cursor: pointer;"></i>\n            </div>\n        `).join(""))(e),t())}catch(e){console.error("Error loading stores:",e),document.getElementById("store-list-container").innerHTML='<p style="text-align: center; color: var(--color-red); padding: 20px;">Failed to load stores.</p>'}};return{render:()=>'\n            <div class="view-header">\n                <a href="#" onclick="renderView(\'setPrices\'); return false;" class="header-action">\n                    CLOSE\n                </a>\n                <h2 class="view-title">Select Store</h2>\n                <div></div>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <div class="input-group" style="display: flex; align-items: flex-end;">\n                    <div style="flex-grow: 1;">\n                        <label for="new-store-name">New Store</label>\n                        <input type="text" id="new-store-name" placeholder="Type new store name...">\n                    </div>\n                    <button id="btn-add-store" class="btn" style="width: 60px; height: 40px; font-size: 0.9rem; background-color: var(--color-primary-blue); color: var(--color-text);">ADD</button>\n                </div>\n            </div>\n\n            <div id="store-list-container">\n                </div>\n        ',initEvents:()=>{a()}}})(),WorkoutHistoryView=(()=>{let e="ALL",t=0,a=(new Date).setFullYear((new Date).getFullYear()+100),n="";const o=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),r=e=>{const t=new Date(e);return`${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}/${t.getFullYear()}`},i=e=>{const t=e.split("/");if(3!==t.length)return null;const a=new Date(`${t[2]}/${t[0]}/${t[1]}`);return isNaN(a)||a.getFullYear()!==parseInt(t[2],10)?null:a},s=e=>0===e.length?'\n                <div style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">\n                    <i class="fas fa-history fa-3x" style="margin-bottom: 15px;"></i>\n                    <p>No logged workout sessions found matching the criteria.</p>\n                </div>\n            ':e.map(e=>{const t=e.exercises.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+(parseFloat(t.reps)||0)*(parseFloat(t.weight)||0),0),0),a=`history-content-${e.id}`;return`\n            <div class="card workout-history-card" style="margin-bottom: 15px; padding: 0;">\n\n                <div class="collapsible-header" data-target="${a}" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer;">\n\n                    <div style="flex-grow: 1;">\n                        <div style="display: flex; align-items: center;">\n                            <h3 id="name-${e.id}" style="margin: 0; font-size: 1.2rem;">${e.workoutName}</h3>\n                            <i class="fas fa-pen rename-history-entry"\n                                data-id="${e.id}"\n                                data-name="${e.workoutName}"\n                                style="color: var(--color-primary-blue); cursor: pointer; font-size: 0.9rem; margin-left: 10px;"></i>\n                        </div>\n\n                        <div style="font-size: 0.9rem; color: var(--color-text-secondary);">\n                            ${o(e.date)} | ${(e=>{if(isNaN(e)||e<0)return"00:00:00";const t=Math.floor(e/3600),a=Math.floor(e%3600/60),n=e%60,o=e=>String(e).padStart(2,"0");return`${o(t)}:${o(a)}:${o(n)}`})(e.duration)}\n                        </div>\n                    </div>\n\n                    <div style="text-align: right;">\n                        <div style="font-size: 0.8rem; color: var(--color-text-secondary);">Volume</div>\n                        <div style="font-weight: bold; font-size: 1.1rem;">${t.toFixed(0)}</div>\n                    </div>\n\n                    <i class="fas fa-chevron-down toggle-icon" style="color: #666; transition: transform 0.3s; margin-left: 15px;"></i>\n                </div>\n\n                <div id="${a}" class="collapsible-content" style="display: none; padding: 0 15px 15px 15px;">\n\n                    ${(e=>{let t="";return e.forEach(e=>{e.sets.forEach((a,n)=>{const o=0===n,r=((parseFloat(a.weight)||0)*(parseFloat(a.reps)||0)).toFixed(1);t+=`\n          <tr>\n              <td style="font-weight: ${o?"bold":"normal"};">${o?e.name:""}</td>\n              <td>${n+1}</td>\n              <td>${a.weight||"-"} kg</td>\n              <td>${a.reps||"-"}</td>\n              <td>${r}</td>\n          </tr>\n        `})}),`\n      <div style="overflow-x: auto;">\n        <table style="min-width: 450px; width: 100%; border-collapse: collapse; font-size: 0.9rem;">\n            <thead>\n                <tr style="border-bottom: 2px solid var(--color-border);">\n                    <th style="text-align: left; padding: 10px 5px;">Exercise</th>\n                    <th style="text-align: left; padding: 10px 5px;">Set</th>\n                    <th style="text-align: left; padding: 10px 5px;">Weight</th>\n                    <th style="text-align: left; padding: 10px 5px;">Reps</th>\n                    <th style="text-align: left; padding: 10px 5px;">Volume</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${t}\n            </tbody>\n        </table>\n      </div>\n    `})(e.exercises)}\n\n                    <div style="margin-top: 15px; text-align: right;">\n                        <button class="btn btn-delete-history" data-id="${e.id}" style="background: none; border: none; color: var(--color-red); font-weight: bold; font-size: 0.9rem; padding: 5px 10px;">\n                            <i class="fas fa-trash"></i> Delete This Entry\n                        </button>\n                    </div>\n\n                </div>\n            </div>\n        `}).join(""),l=async(o,i=null,l=null)=>{e=o;const c=document.getElementById("history-list-container");if(document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),"CUSTOM"!==o){const e=document.getElementById(`filter-range-${o.toLowerCase()}`);e&&e.classList.add("active")}let d,u;if("CUSTOM"===o&&i&&l)d=i,u=l;else if("ALL"===o)d=0,u=(new Date).setFullYear((new Date).getFullYear()+100);else{const e=DataService.getRangeDates(o);d=e.start,u=e.end}t=d,a=u;const p=document.getElementById("btn-select-custom-range");p&&("CUSTOM"===o?(p.innerHTML=`<i class="fas fa-calendar-alt"></i> &nbsp; ${r(t)} - ${r(a)}`,p.style.border="1px solid var(--color-primary-green)"):(p.innerHTML='<i class="fas fa-calendar-alt"></i> &nbsp; Select Custom Range',p.style.border="none")),c&&(c.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 50px 20px;">Loading data...</p>');try{const e=await DataService.getWorkoutHistory(),t=n.toLowerCase();let a=e.filter(e=>e.date>=d&&e.date<=u);t&&(a=a.filter(e=>e.workoutName.toLowerCase().includes(t))),a.sort((e,t)=>t.date-e.date),c&&(c.innerHTML=s(a),m())}catch(e){console.error("Failed to load workout history:",e),c&&(c.innerHTML='<p style="text-align: center; color: var(--color-red); padding: 20px;">ERROR: Could not load data from database. Check console.</p>')}},c=async()=>{if(await showModal("DANGER: DELETE ALL WORKOUT HISTORY","Are you ABSOLUTELY sure you want to delete ALL workout history? This cannot be undone.","confirm"))try{await DataService.clearStore("workoutHistory"),await showModal("Success","All workout history has been cleared.","alert"),n="",l("ALL")}catch(e){console.error("Failed to clear history:",e),await showModal("Error","Failed to clear all workout history.","alert")}},d=async()=>{const e=(await DataService.getWorkoutHistory()).filter(e=>e.date>=t&&e.date<=a);if(0===e.length)return void await showModal("No Data","No workout history to export in this range.","alert");let n="Workout,Date,Duration (s),Exercise,Set,Weight (kg),Reps,Volume\n";e.forEach(e=>{const t=o(e.date),a=e.duration;e.exercises.forEach(o=>{o.sets.forEach((r,i)=>{const s=((parseFloat(r.weight)||0)*(parseFloat(r.reps)||0)).toFixed(1);n+=`"${e.workoutName}","${t}",${a},"${o.name}",${i+1},${r.weight||"0"},${r.reps||"0"},${s}\n`})})});const r=new Blob([n],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download=`WorkoutHistory_Export_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),await showModal("Export Complete","Workout history exported successfully as CSV.","alert")},u=(()=>{const e=document.createElement("input");return e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",e=>{console.log("Import file selected. Logic is deferred to handleImportFile.")}),document.body.appendChild(e),e})(),p=()=>{const e=`\n      <div style="padding: 20px;">\n        <p style="margin-top: 0; color: var(--color-text-secondary);">\n          Select the date range for filtering the workout history.\n        </p>\n        <div class="input-group">\n          <label for="modal-start-date-input">Start Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-start-date-input" placeholder="MM/DD/YYYY" value="${r(t||Date.now())}">\n        </div>\n        <div class="input-group">\n          <label for="modal-end-date-input">End Date (MM/DD/YYYY)</label>\n          <input type="text" id="modal-end-date-input" placeholder="MM/DD/YYYY" value="${r(a||Date.now())}">\n        </div>\n      </div>\n    `;window.showModal("Select Custom Date Range",e,"confirm").then(async e=>{if(e){const e=document.getElementById("modal-start-date-input").value,t=document.getElementById("modal-end-date-input").value,a=i(e),n=i(t);if(!a||!n||a.getTime()>n.getTime())return await showModal("Error","Invalid dates. Please try again.","alert"),void p();n.setHours(23,59,59,999),l("CUSTOM",a.getTime(),n.getTime())}})},m=()=>{document.querySelectorAll(".collapsible-header").forEach(e=>{e.addEventListener("click",()=>(e=>{const t=e.getAttribute("data-target"),a=document.getElementById(t),n=e.querySelector(".toggle-icon");"block"===a.style.display?(a.style.display="none",n.style.transform="rotate(0deg)"):(a.style.display="block",n.style.transform="rotate(180deg)")})(e))}),document.querySelectorAll(".btn-delete-history").forEach(n=>{n.addEventListener("click",o=>{(async n=>{if(await showModal("Delete History Entry","Are you sure you want to delete this workout session?","confirm"))try{await DataService.deleteWorkoutHistoryEntry(parseInt(n,10)),await showModal("Deleted","Workout session removed.","alert"),l(e,t,a)}catch(e){console.error("Deletion failed:",e),await showModal("Error","Failed to delete history entry.","alert")}})(n.dataset.id)})}),document.querySelectorAll(".rename-history-entry").forEach(n=>{n.addEventListener("click",o=>{(async(n,o)=>{if(await showModal("Rename Workout Log",`Enter a new name for the session:\n           <input type="text" id="rename-input" class="input-group" value="${o}"\n           style="width: 95%; margin-top: 10px; padding: 8px; border: 1px solid var(--color-border); background-color: var(--color-background); color: var(--color-text);">`,"confirm")){const r=document.getElementById("rename-input"),i=r?r.value.trim():"";if(!i||i===o)return void await showModal("Validation","Name cannot be empty or the same as the old name.","alert");try{await DataService.updateWorkoutHistoryName(parseInt(n,10),i);const o=document.getElementById(`name-${n}`);o&&(o.textContent=i),l(e,t,a)}catch(e){console.error("Error renaming history entry:",e),await showModal("Error","Failed to rename history entry.","alert")}}})(n.dataset.id,n.dataset.name)})}),document.getElementById("workout-search-input").addEventListener("input",o=>{n=o.target.value.trim(),l(e,t,a)}),document.getElementById("filter-range-all").addEventListener("click",()=>l("ALL")),document.getElementById("filter-range-week").addEventListener("click",()=>l("WEEK")),document.getElementById("filter-range-month").addEventListener("click",()=>l("MONTH")),document.getElementById("filter-range-year").addEventListener("click",()=>l("YEAR")),document.getElementById("btn-select-custom-range").addEventListener("click",p),document.getElementById("btn-import-history").addEventListener("click",()=>u.click()),document.getElementById("btn-export-history").addEventListener("click",d),document.getElementById("btn-delete-all-history").addEventListener("click",c)};return window.WorkoutHistoryView={render:e=>`\n            <div class="view-header">\n                <a href="#" onclick="renderView('workout'); return false;" class="header-action">\n                    <i class="fas fa-arrow-left fa-lg" style="color: var(--color-text);"></i>\n                </a>\n                <h2 class="view-title" style="margin-left: 15px;">Workout History</h2>\n                <div>\n                    <i id="btn-export-history" class="fas fa-cloud-download-alt fa-lg" style="color: var(--color-text); cursor: pointer; margin-right: 15px;"></i>\n                    <i id="btn-import-history" class="fas fa-cloud-upload-alt fa-lg" style="color: var(--color-text); cursor: pointer;"></i>\n                </div>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <div class="search-bar-container" style="margin-top: 15px; margin-bottom: 10px;">\n                    <i class="fas fa-search" style="color: var(--color-text-secondary);"></i>\n                    <input type="text" id="workout-search-input" placeholder="Search by workout name..." value="${n}">\n                </div>\n            </div>\n\n            <div class="category-tabs" style="padding: 0 0 10px 0;">\n                <button id="filter-range-all" class="tab-button active">ALL</button>\n                <button id="filter-range-week" class="tab-button">WEEK</button>\n                <button id="filter-range-month" class="tab-button">MONTH</button>\n                <button id="filter-range-year" class="tab-button">YEAR</button>\n            </div>\n\n            <div style="padding: 0 15px;">\n                <button id="btn-select-custom-range" class="btn" style="background-color: var(--color-card); color: var(--color-text); margin-bottom: 20px; justify-content: flex-start; border: 1px solid transparent;">\n                    <i class="fas fa-calendar-alt"></i> &nbsp; Select Custom Range\n                </button>\n            </div>\n\n\n            <div id="history-list-container" style="padding: 0 15px;">\n                <p style="text-align: center; color: var(--color-text-secondary); padding: 50px;">Loading history data...</p>\n            </div>\n\n            <div class="danger-zone card" style="margin: 20px 15px 20px;">\n                <h3 style="color: var(--color-red); margin-top: 0;">Danger Zone</h3>\n                <button id="btn-delete-all-history" class="btn btn-danger" style="width: 100%;">DELETE ALL WORKOUT HISTORY</button>\n            </div>\n        `,initEvents:e=>{e&&"CUSTOM"===e.rangeType?l("CUSTOM",e.start,e.end):l("ALL"),m()},setCustomRange:(e,t)=>{l("CUSTOM",e,t)}},window.WorkoutHistoryView})(),WorkoutSessionView=(()=>{let e={isActive:!1,workoutName:"",startTime:0,exercises:[],rest:{active:!1,endTime:0,duration:60,intervalId:null},timerIntervalId:null},t=null,a=!1;const n=e=>e.reduce((e,t)=>e+(parseFloat(t.reps)||0)*(parseFloat(t.weight)||0),0).toFixed(1),o=()=>{e.timerIntervalId&&clearInterval(e.timerIntervalId);const t=document.getElementById("session-timer");e.timerIntervalId=setInterval(()=>{const a=Date.now(),n=Math.floor((a-e.startTime)/1e3);var o;t&&(t.textContent=!(o=n)||o<0?"00:00:00":`${Math.floor(o/3600).toString().padStart(2,"0")}:${Math.floor(o%3600/60).toString().padStart(2,"0")}:${Math.floor(o%60).toString().padStart(2,"0")}`)},1e3)},r=()=>{const t=document.getElementById("btn-rest-toggle");if(e.rest.active)return void i();e.rest.active=!0,e.rest.endTime=Date.now()+1e3*e.rest.duration;const a=Math.ceil((e.rest.endTime-Date.now())/1e3);t&&(t.classList.add("active-rest"),t.innerHTML=`<i class="fas fa-undo"></i> STOP (${a}s)`),e.rest.intervalId=setInterval(()=>{const a=Math.ceil((e.rest.endTime-Date.now())/1e3);t&&(t.innerHTML=`<i class="fas fa-undo"></i> STOP (${a}s)`),a<=0&&(i(),window.showModal&&window.showModal("Rest Finished","Time for your next set!","alert"))},1e3)},i=()=>{e.rest.active=!1,clearInterval(e.rest.intervalId),e.rest.intervalId=null;const t=document.getElementById("btn-rest-toggle");t&&(t.classList.remove("active-rest"),t.innerHTML=`<i class="fas fa-clock"></i> REST (${e.rest.duration}s)`)},s=(t,a)=>{const o=t.sets.map((t,n)=>((t,a,n)=>{const o="bodyweight"===e.exercises[t].equipment,r=o?"":`<input type="number" inputmode="decimal" placeholder="Lbs/Kg" value="${n.weight}"\n               data-ex="${t}" data-set="${a}" data-field="weight" class="session-input"\n               style="flex: 1; min-width: 0; padding: 12px; font-size: 16px; background: var(--color-card); border: 1px solid var(--color-border); color: #fff; border-radius: 8px;">`,i=o?"flex: 2;":"flex: 1;";return`\n      <div class="set-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">\n        <span style="width: 20px; font-weight: bold; color: #888; font-size: 1rem; text-align: center;">${a+1}</span>\n\n        <input type="number" inputmode="decimal" placeholder="Reps" value="${n.reps}"\n               data-ex="${t}" data-set="${a}" data-field="reps" class="session-input"\n               style="${i} min-width: 0; padding: 12px; font-size: 16px; background: var(--color-card); border: 1px solid var(--color-border); color: #fff; border-radius: 8px;">\n\n        ${r}\n\n        <div class="btn-delete-set" data-ex="${t}" data-set="${a}"\n             style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;">\n            <i class="fas fa-times" style="color: var(--color-red); font-size: 1.2rem; pointer-events: none;"></i>\n        </div>\n      </div>\n    `})(a,n,t)).join(""),r=`content-ex-${a}`,i=t.isExpanded||!1;return`\n      <div class="card workout-exercise-card" data-ex-index="${a}" draggable="true" data-expanded="${i}" style="margin-bottom: 20px; padding: 0; border-radius: 12px; transition: transform 0.2s; background: var(--color-card);">\n\n        <div class="collapsible-header" data-target="${r}" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer;">\n\n          <div style="min-width: 0; padding-right: 10px; flex-grow: 1;">\n            <h3 style="margin: 0; font-size: 1.3rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.name}</h3>\n            <small id="vol-display-${a}" style="color: #888; font-size: 0.9rem;">Vol: ${n(t.sets)}</small>\n          </div>\n\n          <div style="display: flex; align-items: center; gap: 15px;">\n            <i class="fas fa-chevron-down toggle-icon" style="color: #666; transition: transform 0.3s; transform: rotate(${i?"180deg":"0deg"});"></i>\n            <div class="drag-handle" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: grab; flex-shrink: 0; background: #333; border-radius: 8px; border: 1px solid #444; touch-action: none;">\n                <i class="fas fa-grip-vertical" style="color: #ccc; font-size: 1.4rem; pointer-events: none;"></i>\n            </div>\n          </div>\n        </div>\n\n        <div id="${r}" class="collapsible-content" style="display: ${i?"block":"none"}; padding: 0 15px 15px 15px;">\n          <div style="border-top: 1px solid #333; margin-top: -1px; padding-top: 10px;">\n            <div id="sets-container-${a}">${o}</div>\n\n            <button class="btn btn-add-set" data-ex="${a}"\n                    style="width: 100%; margin-top: 15px; padding: 12px; font-size: 1rem; background: #2a2a2a; border: 1px dashed #666; color: #ccc; border-radius: 8px;">\n                + Add Set\n            </button>\n\n            <button class="btn btn-delete-exercise" data-ex="${a}"\n                    style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.9rem; background: none; border: 1px solid var(--color-red); color: var(--color-red); border-radius: 8px;">\n                <i class="fas fa-trash"></i> Remove Exercise\n            </button>\n          </div>\n        </div>\n      </div>\n    `},l=e=>{const n=e.target.closest(".drag-handle");if(!n)return;const o=n.closest(".workout-exercise-card");o&&(e.preventDefault(),a=!0,t=o,o.classList.add("dragging-workout-card"),o.style.opacity="0.5")},c=e=>{if(!a||!t)return;e.preventDefault();const n=e.targetTouches[0],o=document.elementFromPoint(n.clientX,n.clientY);if(!o)return;const r=o.closest(".workout-exercise-card");if(r&&r!==t){const e=r.getBoundingClientRect(),a=e.top+e.height/2;n.clientY<a?r.parentNode.insertBefore(t,r):r.parentNode.insertBefore(t,r.nextSibling)}},d=e=>{a&&(a=!1,t&&(t.classList.remove("dragging-workout-card"),t.style.opacity="1"),g(),t=null)},u=e=>{const a=e.target.closest(".workout-exercise-card");a&&e.target.closest(".drag-handle")?(t=a,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",a.dataset.exIndex),a.classList.add("dragging-workout-card")):e.preventDefault()},p=e=>{e.preventDefault();const a=e.target.closest(".workout-exercise-card");if(a&&a!==t){const n=a.getBoundingClientRect(),o=n.top+n.height/2;e.clientY<o?a.parentNode.insertBefore(t,a):a.parentNode.insertBefore(t,a.nextSibling)}},m=()=>{t&&t.classList.remove("dragging-workout-card"),g(),t=null},g=()=>{const t=document.getElementById("active-workout-container").querySelectorAll(".workout-exercise-card"),a=[],n=e.exercises.reduce((e,t,a)=>(e[a]=t,e),{});t.forEach(e=>{const t=parseInt(e.dataset.exIndex);n[t]&&a.push(n[t])}),e.exercises=a,v()},y=async()=>{const e=`\n      <div style="padding: 5px;">\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">\n            <h3 style="margin: 0; font-size: 1.2rem;">Select Exercise</h3>\n            <button id="btn-modal-close-x" style="background: none; border: none; color: var(--color-red); font-size: 2rem; cursor: pointer; padding: 0 10px; line-height: 1;">&times;</button>\n        </div>\n        <input type="text" id="modal-search" placeholder="Search..." style="width: 100%; padding: 12px; font-size: 16px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; margin-bottom: 15px;">\n        <div style="display: flex; gap: 10px; margin-bottom: 15px;">\n          <select id="modal-muscle" style="flex:1; padding: 10px; font-size: 14px; background: #333; color: white; border: 1px solid #555; border-radius: 6px;">\n             <option value="All Muscles">All Muscles</option>\n             ${ExerciseData.MUSCLE_GROUPS.map(e=>`<option value="${e}">${e}</option>`).join("")}\n          </select>\n          <select id="modal-equip" style="flex:1; padding: 10px; font-size: 14px; background: #333; color: white; border: 1px solid #555; border-radius: 6px;">\n             <option value="All">All Equip</option>\n             ${ExerciseData.EQUIPMENT_TYPES.map(e=>`<option value="${e}">${e}</option>`).join("")}\n          </select>\n        </div>\n        <div id="modal-results" style="max-height: 50vh; overflow-y: auto; border-top: 1px solid #333;">\n          <p style="text-align: center; color: #888; margin-top: 20px;">Type to search...</p>\n        </div>\n      </div>\n    `;window.showModal&&window.showModal("",e,"custom"),setTimeout(()=>{const e=document.getElementById("btn-modal-close-x"),t=document.getElementById("modal-search"),a=document.getElementById("modal-muscle"),n=document.getElementById("modal-equip"),o=document.getElementById("modal-results");if(e&&e.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),window.closeModal)window.closeModal(!1);else{const e=document.getElementById("universal-modal");e&&(e.style.display="none")}}),!t)return;const r=async()=>{o.innerHTML='<p style="text-align:center; padding: 20px;">Searching...</p>';try{const e=await ExerciseData.searchExercises(t.value,a.value,n.value);if(0===e.length)return void(o.innerHTML='<p style="text-align:center; padding: 20px;">No results found.</p>');o.innerHTML=e.map(e=>`\n            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid #444;">\n              <div style="padding-right: 10px;">\n                <div style="font-weight: bold; font-size: 1rem; margin-bottom: 4px;">${e.name}</div>\n                <small style="color: #888; font-size: 0.85rem;">${e.muscle} | ${e.equipment}</small>\n              </div>\n              <button class="btn-modal-add" data-id="${e.id}" style="background: var(--color-primary-green); color: #000; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer;">ADD</button>\n            </div>\n          `).join(""),document.querySelectorAll(".btn-modal-add").forEach(t=>{t.addEventListener("click",t=>{const a=t.target.getAttribute("data-id"),n=e.find(e=>e.id===a);n&&(f(n),window.closeModal&&window.closeModal(!0))})})}catch(e){console.error(e),o.innerHTML='<p style="color: red; text-align:center;">Error loading data.</p>'}};t.addEventListener("keyup",r),a.addEventListener("change",r),n.addEventListener("change",r),r()},100)},b=()=>{const t=document.getElementById("session-title");t&&(t.textContent=e.workoutName),o(),v(),h()},f=t=>{const a=parseInt(t.sets)||1;e.exercises.push({...t,sets:Array(a).fill({reps:"",weight:""}),isExpanded:!0}),v()},v=()=>{const t=document.getElementById("active-workout-container");t&&(t.innerHTML=e.exercises.map((e,t)=>s(e,t)).join(""))},h=()=>{const t=document.getElementById("active-workout-container");t.oninput&&(t.oninput=null),t.onclick&&(t.onclick=null),t.ondragstart&&(t.ondragstart=null),t.ondragover&&(t.ondragover=null),t.ontouchstart&&(t.ontouchstart=null),t.ontouchmove&&(t.ontouchmove=null),t.ontouchend&&(t.ontouchend=null),t.oninput=t=>{if(t.target.classList.contains("session-input")){const a=t.target.dataset.ex,o=t.target.dataset.set,r=t.target.dataset.field;e.exercises[a].sets[o][r]=t.target.value;const i=document.getElementById(`vol-display-${a}`);if(i){const t=n(e.exercises[a].sets);i.textContent=`Vol: ${t}`}}},t.onclick=t=>{const a=t.target,n=a.closest(".collapsible-header");if(n){if(a.closest(".drag-handle"))return;return void(t=>{const a=t.closest(".workout-exercise-card").dataset.exIndex,n=document.getElementById(t.getAttribute("data-target")),o=t.querySelector(".toggle-icon");"block"===n.style.display?(n.style.display="none",o.style.transform="rotate(0deg)",e.exercises[a].isExpanded=!1):(n.style.display="block",o.style.transform="rotate(180deg)",e.exercises[a].isExpanded=!0)})(n)}const o=a.closest(".btn-delete-set");if(o){const t=o.dataset.ex,a=o.dataset.set;return e.exercises[t].sets.splice(a,1),void v()}const r=a.closest(".btn-delete-exercise");if(r){const t=r.dataset.ex;return e.exercises.splice(t,1),void v()}if(a.classList.contains("btn-add-set")){const t=a.dataset.ex;e.exercises[t].sets.push({reps:"",weight:""}),e.exercises[t].isExpanded=!0,v()}},t.ondragstart=u,t.ondragover=p,t.ondragend=m,t.addEventListener("touchstart",l,{passive:!1}),t.addEventListener("touchmove",c,{passive:!1}),t.addEventListener("touchend",d);const a=document.getElementById("btn-add-exercise-modal"),o=a.cloneNode(!0);a.parentNode.replaceChild(o,a),o.addEventListener("click",y);document.getElementById("rest-select").onchange=t=>{e.rest.duration=parseInt(t.target.value);const a=document.getElementById("btn-rest-toggle");a&&!e.rest.active&&(a.innerHTML=`<i class="fas fa-clock"></i> REST (${e.rest.duration}s)`)};document.getElementById("btn-rest-toggle").onclick=r;document.getElementById("btn-finish").onclick=async()=>{const t=Math.floor((Date.now()-e.startTime)/1e3),a=e.exercises.map(e=>({...e,sets:e.sets.filter(t=>"bodyweight"===e.equipment?t.reps:t.reps&&t.weight)})).filter(e=>e.sets.length>0),n={workoutName:e.workoutName,date:Date.now(),duration:t,exercises:a};await DataService.saveWorkoutSession(n),e.isActive=!1,e.startTime=0,renderView("workoutHistory")}};return{render:()=>'\n      <div class="view-header" style="padding: 15px;">\n        <a href="#" onclick="renderView(\'workout\'); return false;" style="color: var(--color-red); font-weight: bold; font-size: 1rem;">EXIT</a>\n        <h2 id="session-title" style="margin:0; font-size: 1.2rem;">Loading...</h2>\n        <a href="#" id="btn-finish" style="color: var(--color-primary-green); font-weight: bold; font-size: 1rem;">FINISH</a>\n      </div>\n\n      <div style="background: var(--color-card); padding: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid var(--color-border);">\n        <div>\n          <small style="color: #888;">Duration</small>\n          <div id="session-timer" style="font-size: 1.6rem; font-weight: bold; letter-spacing: 1px;">00:00:00</div>\n        </div>\n        <div style="text-align: right;">\n          <select id="rest-select" style="padding: 8px; font-size: 1rem; background: #333; color: #fff; border: none; margin-bottom: 8px; border-radius: 4px;">\n            <option value="30">30s</option>\n            <option value="60" selected>60s</option>\n            <option value="90">90s</option>\n            <option value="120">120s</option>\n          </select>\n          <br>\n          <button id="btn-rest-toggle" class="btn" style="padding: 8px 15px; font-size: 0.9rem; background: var(--color-primary-blue); border-radius: 20px;">\n            <i class="fas fa-clock"></i> REST (60s)\n          </button>\n        </div>\n      </div>\n\n      <div id="active-workout-container" style="padding: 0 15px; padding-bottom: 100px; overflow-x: hidden;"></div>\n\n      <button id="btn-add-exercise-modal" style="position: fixed; bottom: 90px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--color-primary-green); border: none; box-shadow: 0 6px 15px rgba(0,0,0,0.6); color: #000; font-size: 1.8rem; cursor: pointer; z-index: 100; display: flex; justify-content: center; align-items: center;">\n        <i class="fas fa-plus"></i>\n      </button>\n    ',initEvents:async t=>{if(e.isActive&&(!t||t===e.workoutId)&&e.startTime>0)b();else{if(e.isActive=!0,e.startTime=Date.now(),e.exercises=[],e.workoutId=t||null,e.workoutName="Quick Workout",e.timerIntervalId&&clearInterval(e.timerIntervalId),e.rest.intervalId&&clearInterval(e.rest.intervalId),t)try{const a=await DataService.getWorkoutById(t);a&&(e.workoutName=a.name,e.exercises=a.exercises.map(e=>({...e,sets:Array(parseInt(e.sets)||3).fill({reps:"",weight:""})})))}catch(e){console.error("Error loading workout",e)}b()}}}})(),WorkoutView=(()=>{let e=[];const t=async()=>{const t=document.getElementById("workout-list-container");t&&(t.innerHTML='<p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">Loading workouts...</p>');try{e=await DataService.getWorkouts()}catch(t){console.error("Failed to load workouts:",t),e=[],await showModal("Error","Failed to load saved workouts from the database.","alert")}var a;t&&(t.innerHTML=0===(a=e).length?'\n                <div style="text-align: center; color: var(--color-text-secondary); padding: 20px 20px;">\n                    <i class="fas fa-list-alt fa-3x" style="margin-bottom: 15px;"></i>\n                    <p>No saved workout plans.</p>\n                    <p style="font-size: 0.9rem;">Use the \'+\' button above to create your first routine.</p>\n                </div>\n            ':a.map(e=>{const t=e.exercises&&e.exercises.length||0,a=e.id;return`\n            <div class="workout-list-item" data-id="${a}" data-is-expanded="false" style="border-bottom: 1px solid var(--color-border);">\n\n                <div class="workout-header-toggle" data-target="#workout-content-${a}" data-id="${a}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer;">\n                    <div style="flex-grow: 1;">\n                        <div id="workout-name-${a}" style="font-weight: bold;">${e.name}</div>\n                        <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${t} exercises</div>\n                    </div>\n                    <i id="chevron-${a}" class="fas fa-chevron-down fa-sm" style="color: var(--color-text-secondary); transition: transform 0.3s;"></i>\n                </div>\n\n                <div id="workout-content-${a}" class="collapsible-content" style="display: none; padding: 0 15px 15px;">\n\n                    <div class="workout-actions" style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px;">\n                        <button class="btn btn-start" data-id="${a}" style="flex: 1; background-color: var(--color-primary-blue); color: var(--color-text); padding: 10px;">\n                            <i class="fas fa-play"></i> START\n                        </button>\n                        <button class="btn btn-edit" data-id="${a}" style="flex: 1; background: none; border: 1px solid var(--color-text); color: var(--color-text); padding: 10px;">\n                            <i class="fas fa-edit"></i> EDIT\n                        </button>\n                    </div>\n\n                    <div style="display: flex; justify-content: center; gap: 20px;">\n                        <button class="btn btn-rename" data-id="${a}" data-name="${e.name}" style="background: none; border: none; color: var(--color-primary-blue); font-weight: bold; padding: 5px;">\n                            RENAME\n                        </button>\n                        <button class="btn btn-delete" data-id="${a}" style="background: none; border: none; color: var(--color-red); font-weight: bold; padding: 5px;">\n                            DELETE\n                        </button>\n                    </div>\n\n                </div>\n            </div>\n        `}).join(""),n())},a=async()=>{const e=document.getElementById("new-workout-name"),a=e.value.trim();if(a)try{await DataService.saveWorkout(a);e.value="",t()}catch(e){console.error("Error creating workout:",e),await showModal("Error","Could not save the workout to the database.","alert")}else await showModal("Validation","Please enter a name for the new workout.","alert")},n=()=>{document.querySelectorAll(".workout-header-toggle").forEach(e=>{e.addEventListener("click",t=>{(e=>{const t=document.getElementById(`workout-content-${e}`),a=document.getElementById(`chevron-${e}`),n="block"===t.style.display;document.querySelectorAll(".workout-list-item").forEach(t=>{const a=t.getAttribute("data-id"),n=document.getElementById(`workout-content-${a}`),o=document.getElementById(`chevron-${a}`);a!=e&&(n.style.display="none",o&&(o.style.transform="rotate(0deg)"),t.setAttribute("data-is-expanded","false"))}),n?(t.style.display="none",a.style.transform="rotate(0deg)",document.querySelector(`.workout-list-item[data-id="${e}"]`).setAttribute("data-is-expanded","false")):(t.style.display="block",a.style.transform="rotate(180deg)",document.querySelector(`.workout-list-item[data-id="${e}"]`).setAttribute("data-is-expanded","true"))})(e.getAttribute("data-id"))})}),document.querySelectorAll(".btn-rename").forEach(e=>{e.addEventListener("click",()=>{(async(e,t)=>{if(await showModal("Rename Workout",`\n            Enter a new name for "${t}":\n            <input type="text" id="rename-input" class="input-group" value="${t}"\n                style="width: 95%; margin-top: 10px; padding: 8px; border: 1px solid var(--color-border); background-color: var(--color-background); color: var(--color-text);">\n          `,"confirm")){const a=document.getElementById("rename-input"),n=a?a.value.trim():"";if(!n||n===t)return void await showModal("Validation","Name cannot be empty or the same as the old name.","alert");try{await DataService.updateWorkoutName(parseInt(e,10),n),document.getElementById(`workout-name-${e}`).textContent=n,document.querySelector(`.btn-rename[data-id="${e}"]`).setAttribute("data-name",n),await showModal("Success",`Workout renamed to "${n}".`,"alert")}catch(e){console.error("Error renaming workout:",e),await showModal("Error","Failed to rename workout.","alert")}}})(e.dataset.id,e.dataset.name)})}),document.querySelectorAll(".btn-delete").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.id;(async(e,a)=>{if(await showModal("Delete Workout",`Are you sure you want to permanently delete the workout: "${a}"? This cannot be undone.`,"confirm"))try{await DataService.deleteWorkout(e),await showModal("Success",`Workout "${a}" deleted.`,"alert"),t()}catch(e){console.error("Error deleting workout:",e),await showModal("Error","Failed to delete workout.","alert")}})(a,document.getElementById(`workout-name-${a}`).textContent)})}),document.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;renderView("editWorkoutDetail",t)})}),document.querySelectorAll(".btn-start").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;renderView("workoutSession",parseInt(t,10))})})};return{render:()=>'\n            <div class="view-header" style="border-bottom: none; padding-bottom: 0;">\n                <div></div>\n                <h2 class="view-title">Workout Tracker</h2>\n                <div></div>\n            </div>\n\n            <div class="workout-actions" style="padding: 15px;">\n\n                <button id="btn-quick-workout" class="btn" style="background-color: var(--color-primary-blue); color: var(--color-text); margin-bottom: 15px;">\n                    <i class="fas fa-stopwatch"></i> &nbsp; START QUICK WORKOUT\n                </button>\n\n                <button id="btn-workout-history" class="btn" style="background-color: var(--color-card); color: var(--color-text); border: 1px solid var(--color-border); margin-bottom: 30px;">\n                    <i class="fas fa-history"></i> &nbsp; WORKOUT HISTORY\n                </button>\n            </div>\n\n            <h3 style="padding: 0 15px; margin: 0 0 10px; font-weight: bold; color: var(--color-text);">Manage Workouts</h3>\n\n            <div style="padding: 0 15px;">\n                <div id="new-workout-input" class="input-group" style="display: flex; align-items: center; border-bottom: none; padding-bottom: 0;">\n                    <input type="text" id="new-workout-name" placeholder="e.g., Push Day A" style="flex-grow: 1; font-size: 1rem; border-bottom: 1px solid var(--color-border); padding-bottom: 5px;"/>\n                    <button id="btn-create-workout" class="btn" style="width: 50px; height: 35px; font-size: 0.9rem; margin-left: 10px; background-color: var(--color-primary-green); color: var(--color-text);">\n                        <i class="fas fa-plus"></i>\n                    </button>\n                </div>\n            </div>\n\n            <div id="workout-list-container" class="card" style="margin: 15px; margin-top: 10px; padding: 0;">\n                <p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">Loading workouts...</p>\n            </div>\n        ',initEvents:()=>{t(),document.getElementById("btn-quick-workout").addEventListener("click",()=>{renderView("workoutSession",null)}),document.getElementById("btn-workout-history").addEventListener("click",()=>{renderView("workoutHistory")}),document.getElementById("btn-create-workout").addEventListener("click",a)}}})();